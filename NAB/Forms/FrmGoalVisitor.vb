Imports System.Data.SqlClient
Public Class FrmGoalVisitor
    Dim ds_User As New DataTable
    Dim dta_User As New SqlDataAdapter()

    Private Sub GetVisitorList()
        Try
            ds_User.Clear()
            If Not dta_User Is Nothing Then
                dta_User.Dispose()
            End If
            '''''''''''''''''''''''''''
            dta_User = New SqlDataAdapter("SELECT Id, Nam FROM  Define_Visitor", DataSource)
            dta_User.Fill(ds_User)
            CmbBox.DataSource = ds_User
            CmbBox.DisplayMember = "Nam"
            CmbBox.ValueMember = "ID"
        Catch ex As Exception
            GetError(ex.Message & vbCrLf & vbCrLf & ex.StackTrace, "FrmGoalVisitor", "GetVisitorList")
            Me.Close()
        End Try
    End Sub
    Private Sub ChkTime_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles ChkTime.CheckedChanged
        If ChkTime.Checked = True Then
            ChkAzDate.Enabled = True
            ChkTaDate.Enabled = True
            FarsiDate1.Enabled = True
            FarsiDate1.ThisText = GetDate()
            FarsiDate2.Enabled = True
            FarsiDate2.ThisText = GetDate()
            ChkAzDate.Checked = True
            ChkTaDate.Checked = True
        Else
            ChkAzDate.Enabled = False
            ChkTaDate.Enabled = False
            FarsiDate1.Enabled = False
            FarsiDate1.ThisText = GetDate()
            FarsiDate2.Enabled = False
            FarsiDate2.ThisText = GetDate()
            ChkAzDate.Checked = False
            ChkTaDate.Checked = False
        End If
    End Sub

    Private Sub ChkAzDate_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles ChkAzDate.CheckedChanged
        If ChkAzDate.Checked = True Then
            FarsiDate1.ThisText = GetDate()
            FarsiDate1.Enabled = True
            FarsiDate1.Focus()
        Else
            FarsiDate1.Enabled = False
            FarsiDate1.ThisText = GetDate()
        End If
    End Sub

    Private Sub ChkTaDate_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles ChkTaDate.CheckedChanged
        If ChkTaDate.Checked = True Then
            FarsiDate2.ThisText = GetDate()
            FarsiDate2.Enabled = True
            FarsiDate2.Focus()
        Else
            FarsiDate2.Enabled = False
            FarsiDate2.ThisText = GetDate()
        End If
    End Sub

    Private Sub FrmGoalVisitor_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles Me.KeyDown
        Me.GetKey(e)
    End Sub

    Private Sub FrmGoalVisitor_TwoGroup_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load
        Dim theFont As New Font(FontName, FontSize, FontStyle.Regular)

        For Each theControl As Control In (PublicFunction.GetAllControls(Me))
            theControl.Font = theFont
        Next
        Access_Form = Get_Access_Form("F129")
        If (Access_Form <> "-1") Then
            If String.IsNullOrEmpty(Access_Form) Then
                MessageBox.Show("حق دسترسی برای شما تعیین نشده است", "هشدار", MessageBoxButtons.OK, MessageBoxIcon.Asterisk)
                Me.Close()
            Else
                If Access_Form.Substring(0, 1) = 0 Or Access_Form.Substring(1, 1) = 0 Or Access_Form.Substring(2, 1) = 0 Then
                    MessageBox.Show("حق دسترسی به این بخش برای شما مسدود شده است", "هشدار", MessageBoxButtons.OK, MessageBoxIcon.Asterisk)
                    Me.Close()
                End If
            End If
        End If
        ChkAzDate.Enabled = False
        ChkTaDate.Enabled = False
        FarsiDate1.Enabled = False
        FarsiDate2.Enabled = False
        FarsiDate1.ThisText = GetDate()
        FarsiDate2.ThisText = GetDate()
        Me.GetVisitorList()
    End Sub
    Private Function AreYouExistVisitor(ByVal Table As String, ByVal IdVisit As Long) As Boolean
        Try
            If ConectionBank.State <> ConnectionState.Open Then ConectionBank.Open()
            Using CMD As New SqlCommand("SELECT CASE WHEN COUNT(IdVisitor)>0 THEN'True' ELSE 'False' END FROM " & Table & " WHERE IdVisitor =" & IdVisit, ConectionBank)
                If CMD.ExecuteScalar = True Then
                    If ConectionBank.State <> ConnectionState.Closed Then ConectionBank.Close()
                    Return True
                Else
                    If ConectionBank.State <> ConnectionState.Closed Then ConectionBank.Close()
                    Return False
                End If
            End Using
        Catch ex As Exception
            GetError(ex.Message & vbCrLf & vbCrLf & ex.StackTrace, "FrmGoalVisitor", "AreYouExistVisitor")
            Return False
        End Try
    End Function
    Private Sub BtnOk_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles BtnOk.Click
        Try
            If CmbBox.Text = "" Then
                MessageBox.Show("ویزیتوری جهت تهیه گزارش انتخاب نشده است", "هشدار", MessageBoxButtons.OK, MessageBoxIcon.Information)
                CmbBox.Focus()
                Exit Sub
            End If
            If ChkTime.Checked = True Then
                If ChkAzDate.Checked = False And ChkTaDate.Checked = False Then
                    MessageBox.Show("محدوده تاریخ مشخص نشده است", "هشدار", MessageBoxButtons.OK, MessageBoxIcon.Information)
                    Exit Sub
                End If

                If ChkAzDate.Checked = True Then
                    If String.IsNullOrEmpty(FarsiDate1.ThisText) Then
                        MessageBox.Show("تاریخ را انتخاب کنید", "هشدار", MessageBoxButtons.OK, MessageBoxIcon.Information)
                        Exit Sub
                    End If
                End If

                If ChkTaDate.Checked = True Then
                    If String.IsNullOrEmpty(FarsiDate2.ThisText) Then
                        MessageBox.Show("تاریخ را انتخاب کنید", "هشدار", MessageBoxButtons.OK, MessageBoxIcon.Information)
                        Exit Sub
                    End If
                End If

                If ChkAzDate.Checked = True And ChkTaDate.Checked = True Then
                    If FarsiDate1.ThisText > FarsiDate2.ThisText Then
                        MessageBox.Show("محدوده تاریخ اشتباه است", "هشدار", MessageBoxButtons.OK, MessageBoxIcon.Information)
                        Exit Sub
                    End If
                End If
            End If
            If Not AreYouExistVisitor(If(RdoKala.Checked = True, "ListVisitor", If(RdoOne.Checked = True, "ListVisitor_OG", "ListVisitor_G")), CmbBox.SelectedValue) Then
                MessageBox.Show("فروش هدف برای ویزیتور مورد نظر ثبت نشده است", "هشدار", MessageBoxButtons.OK, MessageBoxIcon.Information)
                Exit Sub
            End If

            If CheckBox1.Checked = True Then
                If String.IsNullOrEmpty(TxtGroup.Text) Or String.IsNullOrEmpty(TxtIdGroup.Text) Then
                    MessageBox.Show("هیچ گروهی انتخاب نشده است", "هشدار", MessageBoxButtons.OK, MessageBoxIcon.Information)
                    TxtGroup.Focus()
                    Exit Sub
                End If
            End If

            Dim visitor As String = ""
            If CheckBox1.Checked = True Then
                If Not TxtIdGroup.Text.Contains("-") Then
                    visitor = CLng(TxtIdGroup.Text)
                Else
                    Dim x() As String = TxtIdGroup.Text.Split("-")
                    For i As Integer = 0 To x.Length - 1
                        visitor &= x(i) & ","
                    Next
                    visitor = visitor.Substring(0, visitor.Length - 1)
                End If
            Else
                visitor = CmbBox.SelectedValue
            End If

            Dim dat As String = ""
            Dim dat2 As String = ""
            If ChkAzDate.Checked = True And ChkTaDate.Checked = True Then
                dat = " AND (D_date>=N'" & FarsiDate1.ThisText & "' AND D_date<=N'" & FarsiDate2.ThisText & "')"
                dat2 = " AND (ListFactorSell.D_date>=N'" & FarsiDate1.ThisText & "' AND ListFactorSell.D_date<=N'" & FarsiDate2.ThisText & "')"
            ElseIf ChkAzDate.Checked = True And ChkTaDate.Checked = False Then
                dat = " AND (D_date>=N'" & FarsiDate1.ThisText & "')"
                dat2 = " AND (ListFactorSell.D_date>=N'" & FarsiDate1.ThisText & "')"
            ElseIf ChkAzDate.Checked = False And ChkTaDate.Checked = True Then
                dat = " AND (D_date<=N'" & FarsiDate2.ThisText & "')"
                dat2 = " AND (ListFactorSell.D_date<=N'" & FarsiDate2.ThisText & "')"
            Else
                dat = ""
                dat2 = ""
            End If

            Me.Enabled = False
            Using FrmP As New FrmPrint
                If ChkTime.Checked = False Then
                    FrmP.Str1 = ""
                    FrmP.State = ""
                Else
                    FrmP.Str1 = ""
                    FrmP.State = ""
                    If ChkAzDate.Checked = True Then FrmP.Str1 = FarsiDate1.ThisText
                    If ChkTaDate.Checked = True Then FrmP.State = FarsiDate2.ThisText
                End If
                If ChkZV.Checked = True Then
                    FrmP.Str2 = "1"
                Else
                    FrmP.Str2 = "0"
                End If
                Tmp_Namkala = CmbBox.Text
                Tmp_Mon = CmbBox.SelectedValue
                ''''''''''''''''''''''''''''''''''''
                If RdoOne.Checked = True Then
                    FrmP.PrintSQl = "SELECT MonFrosh,KolFrosh,MonBack,KolBack,MonKasri,KolKari,Discount ,(MonFrosh - MonBack - MonKasri) As EndMon,(KolFrosh - KolBack - KolKari) As EndKol,FixMon=(SELECT ISNULL(SUM(Mon),0) FROM Define_Visitor WHERE Id IN(" & visitor & ")) FROM (SELECT ISNULL(ListAllFrosh.Mon,0) As MonFrosh,ISNULL(ListAllFrosh.KolCount,0) As KolFrosh,ISNULL(ListAllBackFrosh.Mon,0) As MonBack,ISNULL(ListAllBackFrosh.KolCount,0) As KolBack,ISNULL(ListAllKasri.Mon,0) As MonKasri,ISNULL(ListAllKasri.KolCount,0) As KolKari ,ISNULL(AllDisc.Darsad,0)  As Discount FROM (SELECT ROUND(SUM(KolCount),2) As KolCount,ISNULL(SUM(Mon-DarsadMon),0) As Mon FROM (SELECT KolCount,JozCount,Mon,DarsadMon  FROM ListFactorSell INNER JOIN KalaFactorSell ON ListFactorSell.IdFactor = KalaFactorSell.IdFactor WHERE (ListFactorSell.Stat =3 and ListFactorSell.Activ =1 AND ListFactorSell.IdVisitor IN(" & visitor & ")" & dat & ")) As ListFrosh ) As ListAllFrosh,(SELECT ROUND(SUM(KolCount),2) As KolCount,ISNULL(SUM(Mon-DarsadMon),0) As Mon FROM (SELECT KolCount,JozCount,Mon,DarsadMon FROM ListFactorBackSell INNER JOIN KalaFactorBackSell ON ListFactorBackSell.IdFactor = KalaFactorBackSell.IdFactor WHERE (ListFactorBackSell.Activ =1 AND ListFactorBackSell.IdVisitor IN(" & visitor & ")" & dat & ")) As ListBackFrosh ) As ListAllBackFrosh ,(SELECT ROUND(SUM(KolCount),2) As KolCount,ISNULL(SUM(Mon-DarsadMon),0) As Mon FROM (SELECT KolCount,JozCount,Mon,DarsadMon FROM KalaKasriFactor INNER JOIN ListKasriFactor ON KalaKasriFactor.IdFactor = ListKasriFactor.IdFactor INNER JOIN ListFactorSell ON ListKasriFactor.IdFactor = ListFactorSell.IdFactor  WHERE IdVisitor IN(" & visitor & ")" & dat2 & ") As ListKasri ) As ListAllKasri,(SELECT ISNULL(SUM(Darsad),0) As Darsad FROM (SELECT ISNULL(SUM(Discount),0) As Darsad FROM  ListFactorSell WHERE (ListFactorSell.Activ =1 AND ListFactorSell.IdVisitor IN(" & visitor & ") And ListFactorSell.Stat =3 AND Discount >0 " & dat & ") UNION ALL SELECT ISNULL(SUM(Discount) * -1,0) As Darsad FROM  ListFactorBackSell WHERE (ListFactorBackSell .Activ =1 AND ListFactorBackSell .IdVisitor IN(" & visitor & ") AND Discount >0 " & dat & ")  UNION ALL SELECT ISNULL(SUM(Discount),0) As Discount FROM  Get_Pay_Sanad WHERE Get_Pay_Sanad.[State] =0 AND Get_Pay_Sanad.Active  =1 AND Id IN (SELECT IdSanad FROM (SELECT IdSanad,COUNT(IdSanad ) As C_Count FROM PayLimitFrosh WHERE IdSanad IN (SELECT IdSanad FROM PayLimitFrosh WHERE IdFactor IN(SELECT IdFactor FROM ListFactorSell WHERE ListFactorSell.Activ =1 AND ListFactorSell.Stat =3 AND ListFactorSell.IdVisitor IN(" & visitor & ")" & dat & ")) GROUP BY IdSanad) As ListSanad WHERE C_Count =1)) AS AllDiscount) As AllDisc ) As InfoVisit"
                    If ChkGroup.Checked = True Then
                        FrmP.Lend = "DECLARE @Cal int SET @Cal=" & If(RdoMon.Checked = True, 0, If(RdoHajm.Checked = True, 1, 2)) & " SELECT NamOne As GroupKala,nam As GroupNam,Mon,Kala,FroshK,KolCountK,DarsadFrosh,DarsadPorsant,MonPorsant FROM (SELECT  Idkala,IdGroup ,MAX(Mon) AS Mon,MAX(Kala) AS Kala,SUM(FroshK) AS FroshK,SUM(KolCountK) AS KolCountK,SUM(DarsadFrosh) AS DarsadFrosh,DarsadPorsant=CASE WHEN SUM(FroshK)<=0 THEN 0 ELSE ROUND(SUM(ROUND(ListPorsant.FroshK *ListPorsant.DarsadPorsant /100,0))*100/SUM(FroshK),2) END,MonPorsant=SUM(ROUND(ListPorsant.FroshK *ListPorsant.DarsadPorsant /100,0)) FROM (SELECT Idkala ,IdGroup,Mon,Kala,FroshK,KolCountK,DarsadFrosh,DarsadPorsant=(SELECT ISNULL(SUM(Darsad),0)  As Darsad FROM (SELECT TOP 1 Darsad FROM  ListDarsad_OG WHERE IdlinkKala =EndList.Id AND IdGroup =EndList.IdGroup AND Frosh <=EndList.DarsadFrosh ORDER By Frosh DESC) As DFrosh) FROM (SELECT Id,Idkala,Mon,Kala,IdVisitor ,IdGroup ,FroshK,KolCountK,DarsadFrosh=CASE WHEN @Cal=0 OR (@Cal=2 AND Mon>0) THEN CASE WHEN Mon<=0 THEN 0 ELSE ROUND(FroshK *100/Mon,2) END WHEN @Cal=1 OR (@Cal=2 AND Kala>0 AND Mon <=0) THEN CASE WHEN Kala<=0 THEN 0 ELSE ROUND(KolCountK *100/Kala ,2) END ELSE 0 END FROM (SELECT MAX(Id) AS Id,Idkala,MAX(Mon) As Mon,MAX(Kala) As Kala,MAX(IdVisitor) AS IdVisitor,IdGroup,SUM(FroshK) AS FroshK,SUM(KolCountK) AS KolCountK FROM (SELECT GroupKala,Id,Idkala,Mon,Kala,IdVisitor ,IdGroup ,FroshK=(SELECT ISNULL(ListAllFrosh.Mon,0) -ISNULL(ListAllBackFrosh.Mon,0)-ISNULL(ListAllKasri.Mon,0) As EndMon FROM (SELECT ISNULL(SUM(Mon),0) As Mon FROM (SELECT Mon-DarsadMon As Mon FROM KalaFactorSell INNER JOIN ListFactorSell ON KalaFactorSell.IdFactor = ListFactorSell.IdFactor WHERE (ListFactorSell.Stat =3 and ListFactorSell.Activ =1 AND ListFactorSell.IdVisitor IN(" & visitor & ") AND KalaFactorSell.IdKala =ListGoal.idK " & dat & " AND IdName IN (SELECT Id FROM Define_People WHERE Define_People.IdGroup=ListGoal .IdGroup AND Define_People.ChkIdGroup ='True'))) As ListFrosh ) As ListAllFrosh,(SELECT ISNULL(SUM(Mon),0) As Mon FROM (SELECT Mon-DarsadMon As Mon FROM KalaFactorBackSell INNER JOIN ListFactorBackSell ON KalaFactorBackSell.IdFactor = ListFactorBackSell.IdFactor WHERE (ListFactorBackSell.Activ =1 AND ListFactorBackSell.IdVisitor IN(" & visitor & ") AND KalaFactorBackSell.IdKala =ListGoal.idK " & dat & " AND IdName IN (SELECT Id FROM Define_People WHERE Define_People.IdGroup=ListGoal .IdGroup AND Define_People.ChkIdGroup ='True'))) As ListBackFrosh ) As ListAllBackFrosh ,(SELECT ISNULL(SUM(Mon),0) As Mon FROM (SELECT Mon-DarsadMon As Mon FROM KalaKasriFactor INNER JOIN ListKasriFactor ON KalaKasriFactor.IdFactor = ListKasriFactor.IdFactor INNER JOIN ListFactorSell ON ListKasriFactor.IdFactor = ListFactorSell.IdFactor  WHERE IdVisitor IN(" & visitor & ") AND KalaKasriFactor.IdR =ListGoal.idK " & dat2 & " AND IdName IN (SELECT Id FROM Define_People WHERE Define_People.IdGroup=ListGoal .IdGroup AND Define_People.ChkIdGroup ='True')) As ListKasri ) As ListAllKasri),KolCountK=CASE WHEN @Cal=0 THEN 0 WHEN @Cal=1 OR (@Cal=2 AND Kala>0 AND Mon <=0) THEN (SELECT ISNULL(ListAllFrosh.KolCount,0) -ISNULL(ListAllBackFrosh.KolCount,0)-ISNULL(ListAllKasri.KolCount,0) As KolCountK FROM (SELECT ISNULL(SUM(KolCount),0) As KolCount FROM (SELECT KolCount  FROM KalaFactorSell INNER JOIN ListFactorSell ON ListFactorSell.IdFactor = KalaFactorSell.IdFactor WHERE (ListFactorSell.Stat =3 and ListFactorSell.Activ =1 AND ListFactorSell.IdVisitor IN(" & visitor & ") AND KalaFactorSell.IdKala =ListGoal.idK " & dat & " AND IdName IN (SELECT Id FROM Define_People WHERE Define_People.IdGroup=ListGoal .IdGroup AND Define_People.ChkIdGroup ='True'))) As ListFrosh ) As ListAllFrosh,(SELECT ISNULL(SUM(KolCount),0) As KolCount FROM (SELECT KolCount  FROM KalaFactorBackSell INNER JOIN ListFactorBackSell ON ListFactorBackSell.IdFactor = KalaFactorBackSell.IdFactor  WHERE (ListFactorBackSell.Activ =1 AND ListFactorBackSell.IdVisitor =ListGoal.IdVisitor AND KalaFactorBackSell.IdKala =ListGoal.idK " & dat & " AND IdName IN (SELECT Id FROM Define_People WHERE Define_People.IdGroup=ListGoal.IdGroup AND Define_People.ChkIdGroup ='True'))) As ListBackFrosh ) As ListAllBackFrosh ,(SELECT ISNULL(SUM(KolCount),0) As KolCount FROM (SELECT KolCount  FROM KalaKasriFactor INNER JOIN ListKasriFactor ON KalaKasriFactor.IdFactor = ListKasriFactor.IdFactor INNER JOIN ListFactorSell ON ListKasriFactor.IdFactor = ListFactorSell.IdFactor  WHERE IdVisitor IN(" & visitor & ") AND KalaKasriFactor.IdR =ListGoal.idK " & dat2 & " AND IdName IN (SELECT Id FROM Define_People WHERE Define_People.IdGroup=ListGoal.IdGroup AND Define_People.ChkIdGroup ='True')) As ListKasri ) As ListAllKasri) ELSE 0 END FROM (SELECT  DISTINCT Define_OneGroup.NamOne As GroupKala,Listkala_OG.Id,Listkala_OG.Idkala,Listkala_OG.Mon,Listkala_OG.Kala,Listkala_OG.IdLinkVisitor As IdVisitor,ListDarsad_OG.IdGroup,Define_Kala.Id AS IdK FROM  Listkala_OG INNER JOIN Define_OneGroup ON Listkala_OG.Idkala = Define_OneGroup.Id INNER JOIN ListDarsad_OG ON Listkala_OG.Id = ListDarsad_OG.IdlinkKala INNER JOIN Define_Kala ON Define_Kala.IdCodeOne =Listkala_OG.Idkala WHERE IdLinkVisitor =" & CmbBox.SelectedValue & ") As ListGoal)As ListGoal2 GROUP By Idkala,IdGroup ) As ListFrosh) As EndList) As ListPorsant GROUP BY Idkala,IdGroup) As ListPorsantEnd INNER JOIN Define_OneGroup ON Define_OneGroup.Id =ListPorsantEnd.Idkala INNER JOIN Define_Group_P ON Define_Group_P.Id =ListPorsantEnd.IdGroup ORDER BY GroupKala"
                        FrmP.IdFactor = "DECLARE @Cal int SET @Cal=" & If(RdoMon.Checked = True, 0, If(RdoHajm.Checked = True, 1, 2)) & " SELECT Nam,FroshK,KolCountK,Darsad,Porsant=ROUND(FroshK *Darsad /100,0)FROM (SELECT Nam,Darsad,FroshK=(SELECT ISNULL(ListAllFrosh.Mon,0) -ISNULL(ListAllBackFrosh.Mon,0)-ISNULL(ListAllKasri.Mon,0) As EndMon FROM (SELECT ISNULL(SUM(Mon),0) As Mon FROM (SELECT Mon-DarsadMon AS Mon  FROM KalaFactorSell INNER JOIN ListFactorSell ON ListFactorSell.IdFactor = KalaFactorSell.IdFactor WHERE (ListFactorSell.Stat =3 and ListFactorSell.Activ =1 AND ListFactorSell.IdVisitor IN(" & visitor & ") AND KalaFactorSell.IdKala NOT IN (SELECT Id  FROM Define_Kala WHERE Id IN (SELECT  Idkala FROM Listkala_OG WHERE IdLinkVisitor =ListOder.IdVisitor)) AND ListFactorSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListOder.IdGroup  AND ChkIdGroup ='True') " & dat & ")) As ListFrosh ) As ListAllFrosh,(SELECT ISNULL(SUM(Mon),0) As Mon FROM (SELECT Mon-DarsadMon AS Mon FROM KalaFactorBackSell INNER JOIN ListFactorBackSell ON ListFactorBackSell.IdFactor = KalaFactorBackSell.IdFactor WHERE (ListFactorBackSell.Activ =1 AND ListFactorBackSell.IdVisitor IN(" & visitor & ") AND KalaFactorBackSell.IdKala NOT IN (SELECT Id  FROM Define_Kala WHERE Id IN (SELECT  Idkala FROM Listkala_OG WHERE IdLinkVisitor =ListOder.IdVisitor)) AND ListFactorBackSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListOder.IdGroup  AND ChkIdGroup ='True') " & dat & ")) As ListBackFrosh ) As ListAllBackFrosh ,(SELECT ISNULL(SUM(Mon),0) As Mon FROM (SELECT Mon-DarsadMon AS Mon FROM KalaKasriFactor INNER JOIN ListKasriFactor ON KalaKasriFactor.IdFactor = ListKasriFactor.IdFactor INNER JOIN ListFactorSell ON ListKasriFactor.IdFactor = ListFactorSell.IdFactor  WHERE IdVisitor IN(" & visitor & ") AND KalaKasriFactor.IdR NOT IN (SELECT Id  FROM Define_Kala WHERE Id IN (SELECT  Idkala FROM Listkala_OG WHERE IdLinkVisitor =ListOder.IdVisitor)) AND ListFactorSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListOder.IdGroup  AND ChkIdGroup ='True') " & dat2 & ") As ListKasri ) As ListAllKasri) ,KolCountK=CASE WHEN @Cal=1 THEN (SELECT ISNULL(ListAllFrosh.KolCount,0) -ISNULL(ListAllBackFrosh.KolCount,0)-ISNULL(ListAllKasri.KolCount,0) As EndKolCount FROM (SELECT ISNULL(SUM(KolCount),0) As KolCount FROM (SELECT KolCount  FROM KalaFactorSell INNER JOIN ListFactorSell ON ListFactorSell.IdFactor = KalaFactorSell.IdFactor WHERE (ListFactorSell.Stat =3 and ListFactorSell.Activ =1 AND ListFactorSell.IdVisitor IN(" & visitor & ") AND KalaFactorSell.IdKala NOT IN (SELECT Id  FROM Define_Kala WHERE Id IN (SELECT  Idkala FROM Listkala_OG  WHERE IdLinkVisitor =ListOder.IdVisitor)) AND ListFactorSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListOder.IdGroup  AND ChkIdGroup ='True') " & dat & ")) As ListFrosh ) As ListAllFrosh,(SELECT ISNULL(SUM(KolCount),0) As KolCount FROM (SELECT KolCount FROM KalaFactorBackSell INNER JOIN ListFactorBackSell ON ListFactorBackSell.IdFactor = KalaFactorBackSell.IdFactor WHERE (ListFactorBackSell.Activ =1 AND ListFactorBackSell.IdVisitor IN(" & visitor & ") AND KalaFactorBackSell.IdKala NOT IN (SELECT Id  FROM Define_Kala WHERE Id IN (SELECT  Idkala FROM Listkala_OG WHERE IdLinkVisitor =ListOder.IdVisitor)) AND ListFactorBackSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListOder.IdGroup  AND ChkIdGroup ='True') " & dat & ")) As ListBackFrosh ) As ListAllBackFrosh ,(SELECT ISNULL(SUM(KolCount),0) As KolCount FROM (SELECT KolCount FROM KalaKasriFactor INNER JOIN ListKasriFactor ON KalaKasriFactor.IdFactor = ListKasriFactor.IdFactor INNER JOIN ListFactorSell ON ListKasriFactor.IdFactor = ListFactorSell.IdFactor  WHERE IdVisitor IN(" & visitor & ") AND KalaKasriFactor.IdR NOT IN (SELECT Id  FROM Define_Kala WHERE Id IN (SELECT  Idkala FROM Listkala_OG  WHERE IdLinkVisitor =ListOder.IdVisitor)) AND ListFactorSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListOder.IdGroup  AND ChkIdGroup ='True') " & dat2 & ") As ListKasri ) As ListAllKasri) ELSE 0 END FROM (SELECT ListOrderDarsad_OG.Darsad,ListOrderDarsad_OG.IdGroup ,ListOrderDarsad_OG.IdLinkVisitor AS IdVisitor,Define_Group_P.nam FROM   ListOrderDarsad_OG INNER JOIN Define_Group_P  ON ListOrderDarsad_OG.IdGroup  = Define_Group_P.Id WHERE  IdLinkVisitor =" & CmbBox.SelectedValue & ") As ListOder) As ListAllOder"
                        If RdoHybrid.Checked = True Then
                            FrmP.CHoose = "GOALONE"
                        ElseIf RdoHajm.Checked = True Then
                            FrmP.CHoose = "GOALONE_HAJM"
                        ElseIf RdoMon.Checked = True Then
                            FrmP.CHoose = "GOALONE_MON"
                        End If
                    Else
                        FrmP.Lend = "DECLARE @Cal int SET @Cal=" & If(RdoMon.Checked = True, 0, If(RdoHajm.Checked = True, 1, 2)) & " SELECT NamOne As GroupKala,Mon,Kala,FroshK,KolCountK,DarsadFrosh,DarsadPorsant,MonPorsant FROM (SELECT Idkala,MAX(Mon) AS Mon,MAX(Kala) AS Kala,SUM(FroshK) AS FroshK,SUM(KolCountK) AS KolCountK,SUM(DarsadFrosh) AS DarsadFrosh,DarsadPorsant=CASE WHEN SUM(FroshK)<=0 THEN 0 ELSE ROUND(SUM(ROUND(ListPorsant.FroshK *ListPorsant.DarsadPorsant /100,0))*100/SUM(FroshK),2) END,MonPorsant=SUM(ROUND(ListPorsant.FroshK *ListPorsant.DarsadPorsant /100,0)) FROM (SELECT Idkala ,Mon,Kala,FroshK,KolCountK,DarsadFrosh,DarsadPorsant=(SELECT ISNULL(SUM(Darsad),0)  As Darsad FROM (SELECT TOP 1 Darsad FROM  ListDarsad_OG WHERE IdlinkKala =EndList.Id AND IdGroup =EndList.IdGroup AND Frosh <=EndList.DarsadFrosh ORDER By Frosh DESC) As DFrosh) FROM (SELECT Id,Idkala,Mon,Kala,IdVisitor,IdGroup,FroshK,KolCountK,DarsadFrosh=CASE WHEN @Cal=0 OR (@Cal=2 AND Mon>0) THEN CASE WHEN Mon<=0 THEN 0 ELSE ROUND(FroshK *100/Mon,2) END WHEN @Cal=1 OR (@Cal=2 AND Kala>0 AND Mon <=0) THEN CASE WHEN Kala<=0 THEN 0 ELSE ROUND(KolCountK *100/Kala ,2) END ELSE 0 END  FROM (SELECT MAX(Id) AS Id,Idkala,MAX(Mon) As Mon,MAX(Kala) As Kala,MAX(IdVisitor) AS IdVisitor,IdGroup,SUM(FroshK) AS FroshK,SUM(KolCountK) AS KolCountK FROM (SELECT GroupKala,Id,Idkala,Mon,Kala,IdVisitor,IdGroup,FroshK=(SELECT ISNULL(ListAllFrosh.Mon,0) -ISNULL(ListAllBackFrosh.Mon,0)-ISNULL(ListAllKasri.Mon,0) As EndMon FROM (SELECT ISNULL(SUM(Mon),0) As Mon FROM (SELECT Mon-DarsadMon As Mon FROM KalaFactorSell INNER JOIN ListFactorSell ON KalaFactorSell.IdFactor = ListFactorSell.IdFactor WHERE (ListFactorSell.Stat =3 and ListFactorSell.Activ =1 AND ListFactorSell.IdVisitor IN(" & visitor & ") AND KalaFactorSell.IdKala =ListGoal.idK " & dat & " AND IdName IN (SELECT Id FROM Define_People WHERE Define_People.IdGroup=ListGoal .IdGroup AND Define_People.ChkIdGroup ='True'))) As ListFrosh ) As ListAllFrosh,(SELECT ISNULL(SUM(Mon),0) As Mon FROM (SELECT Mon-DarsadMon As Mon FROM KalaFactorBackSell INNER JOIN ListFactorBackSell ON KalaFactorBackSell.IdFactor = ListFactorBackSell.IdFactor WHERE (ListFactorBackSell.Activ =1 AND ListFactorBackSell.IdVisitor IN(" & visitor & ") AND KalaFactorBackSell.IdKala =ListGoal.idK " & dat & " AND IdName IN (SELECT Id FROM Define_People WHERE Define_People.IdGroup=ListGoal .IdGroup AND Define_People.ChkIdGroup ='True'))) As ListBackFrosh ) As ListAllBackFrosh ,(SELECT ISNULL(SUM(Mon),0) As Mon FROM (SELECT Mon-DarsadMon As Mon FROM KalaKasriFactor INNER JOIN ListKasriFactor ON KalaKasriFactor.IdFactor = ListKasriFactor.IdFactor INNER JOIN ListFactorSell ON ListKasriFactor.IdFactor = ListFactorSell.IdFactor  WHERE IdVisitor IN(" & visitor & ") AND KalaKasriFactor.IdR =ListGoal.idK " & dat2 & " AND IdName IN (SELECT Id FROM Define_People WHERE Define_People.IdGroup=ListGoal .IdGroup AND Define_People.ChkIdGroup ='True')) As ListKasri ) As ListAllKasri),KolCountK=CASE WHEN @Cal=0 THEN 0 WHEN @Cal=1 OR (@Cal=2 AND Kala>0 AND Mon <=0) THEN (SELECT ISNULL(ListAllFrosh.KolCount,0) -ISNULL(ListAllBackFrosh.KolCount,0)-ISNULL(ListAllKasri.KolCount,0) As KolCountK FROM (SELECT ISNULL(SUM(KolCount),0) As KolCount FROM (SELECT KolCount  FROM KalaFactorSell INNER JOIN ListFactorSell ON ListFactorSell.IdFactor = KalaFactorSell.IdFactor WHERE (ListFactorSell.Stat =3 and ListFactorSell.Activ =1 AND ListFactorSell.IdVisitor IN(" & visitor & ") AND KalaFactorSell.IdKala =ListGoal.idK " & dat & " AND IdName IN (SELECT Id FROM Define_People WHERE Define_People.IdGroup=ListGoal .IdGroup AND Define_People.ChkIdGroup ='True'))) As ListFrosh ) As ListAllFrosh,(SELECT ISNULL(SUM(KolCount),0) As KolCount FROM (SELECT KolCount  FROM KalaFactorBackSell INNER JOIN ListFactorBackSell ON ListFactorBackSell.IdFactor = KalaFactorBackSell.IdFactor  WHERE (ListFactorBackSell.Activ =1 AND ListFactorBackSell.IdVisitor IN(" & visitor & ") AND KalaFactorBackSell.IdKala =ListGoal.idK " & dat & " AND IdName IN (SELECT Id FROM Define_People WHERE Define_People.IdGroup=ListGoal.IdGroup AND Define_People.ChkIdGroup ='True'))) As ListBackFrosh ) As ListAllBackFrosh ,(SELECT ISNULL(SUM(KolCount),0) As KolCount FROM (SELECT KolCount  FROM KalaKasriFactor INNER JOIN ListKasriFactor ON KalaKasriFactor.IdFactor = ListKasriFactor.IdFactor INNER JOIN ListFactorSell ON ListKasriFactor.IdFactor = ListFactorSell.IdFactor  WHERE IdVisitor IN(" & visitor & ") AND KalaKasriFactor.IdR =ListGoal.idK " & dat2 & " AND IdName IN (SELECT Id FROM Define_People WHERE Define_People.IdGroup=ListGoal .IdGroup AND Define_People.ChkIdGroup ='True')) As ListKasri ) As ListAllKasri) ELSE 0 END FROM (SELECT  DISTINCT Define_OneGroup.NamOne As GroupKala,Listkala_OG.Id,Listkala_OG.Idkala,Listkala_OG.Mon,Listkala_OG.Kala,Listkala_OG.IdLinkVisitor As IdVisitor,ListDarsad_OG.IdGroup,Define_Kala.Id AS IdK FROM  Listkala_OG INNER JOIN Define_OneGroup ON Listkala_OG.Idkala = Define_OneGroup.Id INNER JOIN ListDarsad_OG ON Listkala_OG.Id = ListDarsad_OG.IdlinkKala INNER JOIN Define_Kala ON Define_Kala.IdCodeOne =Listkala_OG.Idkala WHERE IdLinkVisitor =" & CmbBox.SelectedValue & ") As ListGoal)As ListGoal2 GROUP By Idkala,IdGroup ) As ListFrosh) As EndList) As ListPorsant GROUP BY Idkala) As ListPorsantEnd INNER JOIN Define_OneGroup ON Define_OneGroup.Id =ListPorsantEnd.Idkala ORDER BY GroupKala"
                        FrmP.IdFactor = "DECLARE @Cal int SET @Cal=" & If(RdoMon.Checked = True, 0, If(RdoHajm.Checked = True, 1, 2)) & " SELECT SUM(FroshK) AS FroshK,SUM(KolCountK) AS KolCountK,Darsad=CASE WHEN SUM(FroshK)<=0 THEN 0 ELSE ROUND(SUM(ROUND(FroshK *Darsad /100,0))*100/SUM(FroshK),2) END,Porsant=SUM(ROUND(FroshK *Darsad /100,0)) FROM (SELECT Nam,Darsad,FroshK=(SELECT ISNULL(ListAllFrosh.Mon,0) -ISNULL(ListAllBackFrosh.Mon,0)-ISNULL(ListAllKasri.Mon,0) As EndMon FROM (SELECT ISNULL(SUM(Mon),0) As Mon FROM (SELECT Mon-DarsadMon AS Mon  FROM KalaFactorSell INNER JOIN ListFactorSell ON ListFactorSell.IdFactor = KalaFactorSell.IdFactor WHERE (ListFactorSell.Stat =3 and ListFactorSell.Activ =1 AND ListFactorSell.IdVisitor IN(" & visitor & ") AND KalaFactorSell.IdKala NOT IN (SELECT Id  FROM Define_Kala WHERE Id IN (SELECT  Idkala FROM Listkala_OG WHERE IdLinkVisitor =ListOder.IdVisitor)) AND ListFactorSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListOder.IdGroup  AND ChkIdGroup ='True') " & dat & ")) As ListFrosh ) As ListAllFrosh,(SELECT ISNULL(SUM(Mon),0) As Mon FROM (SELECT Mon-DarsadMon AS Mon FROM KalaFactorBackSell INNER JOIN ListFactorBackSell ON ListFactorBackSell.IdFactor = KalaFactorBackSell.IdFactor WHERE (ListFactorBackSell.Activ =1 AND ListFactorBackSell.IdVisitor IN(" & visitor & ") AND KalaFactorBackSell.IdKala NOT IN (SELECT Id  FROM Define_Kala WHERE Id IN (SELECT  Idkala FROM Listkala_OG WHERE IdLinkVisitor =ListOder.IdVisitor)) AND ListFactorBackSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListOder.IdGroup  AND ChkIdGroup ='True') " & dat & ")) As ListBackFrosh ) As ListAllBackFrosh ,(SELECT ISNULL(SUM(Mon),0) As Mon FROM (SELECT Mon-DarsadMon AS Mon FROM KalaKasriFactor INNER JOIN ListKasriFactor ON KalaKasriFactor.IdFactor = ListKasriFactor.IdFactor INNER JOIN ListFactorSell ON ListKasriFactor.IdFactor = ListFactorSell.IdFactor  WHERE IdVisitor IN(" & visitor & ") AND KalaKasriFactor.IdR NOT IN (SELECT Id  FROM Define_Kala WHERE Id IN (SELECT  Idkala FROM Listkala_OG WHERE IdLinkVisitor =ListOder.IdVisitor)) AND ListFactorSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListOder.IdGroup  AND ChkIdGroup ='True') " & dat2 & ") As ListKasri ) As ListAllKasri) ,KolCountK=CASE WHEN @Cal=1 THEN (SELECT ISNULL(ListAllFrosh.KolCount,0) -ISNULL(ListAllBackFrosh.KolCount,0)-ISNULL(ListAllKasri.KolCount,0) As EndKolCount FROM (SELECT ISNULL(SUM(KolCount),0) As KolCount FROM (SELECT KolCount  FROM KalaFactorSell INNER JOIN ListFactorSell ON ListFactorSell.IdFactor = KalaFactorSell.IdFactor WHERE (ListFactorSell.Stat =3 and ListFactorSell.Activ =1 AND ListFactorSell.IdVisitor IN(" & visitor & ") AND KalaFactorSell.IdKala NOT IN (SELECT Id  FROM Define_Kala WHERE Id IN (SELECT  Idkala FROM Listkala_OG  WHERE IdLinkVisitor =ListOder.IdVisitor)) AND ListFactorSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListOder.IdGroup  AND ChkIdGroup ='True') " & dat & ")) As ListFrosh ) As ListAllFrosh,(SELECT ISNULL(SUM(KolCount),0) As KolCount FROM (SELECT KolCount FROM KalaFactorBackSell INNER JOIN ListFactorBackSell ON ListFactorBackSell.IdFactor = KalaFactorBackSell.IdFactor WHERE (ListFactorBackSell.Activ =1 AND ListFactorBackSell.IdVisitor IN(" & visitor & ") AND KalaFactorBackSell.IdKala NOT IN (SELECT Id  FROM Define_Kala WHERE Id IN (SELECT  Idkala FROM Listkala_OG WHERE IdLinkVisitor =ListOder.IdVisitor)) AND ListFactorBackSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListOder.IdGroup  AND ChkIdGroup ='True') " & dat & ")) As ListBackFrosh ) As ListAllBackFrosh ,(SELECT ISNULL(SUM(KolCount),0) As KolCount FROM (SELECT KolCount FROM KalaKasriFactor INNER JOIN ListKasriFactor ON KalaKasriFactor.IdFactor = ListKasriFactor.IdFactor INNER JOIN ListFactorSell ON ListKasriFactor.IdFactor = ListFactorSell.IdFactor  WHERE IdVisitor IN(" & visitor & ") AND KalaKasriFactor.IdR NOT IN (SELECT Id  FROM Define_Kala WHERE Id IN (SELECT  Idkala FROM Listkala_OG  WHERE IdLinkVisitor =ListOder.IdVisitor)) AND ListFactorSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListOder.IdGroup  AND ChkIdGroup ='True') " & dat2 & ") As ListKasri ) As ListAllKasri) ELSE 0 END FROM (SELECT ListOrderDarsad_OG.Darsad,ListOrderDarsad_OG.IdGroup ,ListOrderDarsad_OG.IdLinkVisitor AS IdVisitor,Define_Group_P.nam FROM   ListOrderDarsad_OG INNER JOIN Define_Group_P  ON ListOrderDarsad_OG.IdGroup  = Define_Group_P.Id WHERE  IdLinkVisitor =" & CmbBox.SelectedValue & ") As ListOder) As ListAllOder"
                        If RdoHybrid.Checked = True Then
                            FrmP.CHoose = "GOALONE_G"
                        ElseIf RdoHajm.Checked = True Then
                            FrmP.CHoose = "GOALONE_G_HAJM"
                        ElseIf RdoMon.Checked = True Then
                            FrmP.CHoose = "GOALONE_G_MON"
                        End If
                    End If
                ElseIf RdoTwo.Checked = True Then
                    FrmP.PrintSQl = "SELECT MonFrosh,KolFrosh,MonBack,KolBack,MonKasri,KolKari,Discount ,(MonFrosh - MonBack - MonKasri) As EndMon,(KolFrosh - KolBack - KolKari) As EndKol,FixMon=(SELECT ISNULL(SUM(Mon),0) FROM Define_Visitor WHERE Id IN (" & visitor & ")) FROM (SELECT ISNULL(ListAllFrosh.Mon,0) As MonFrosh,ISNULL(ListAllFrosh.KolCount,0) As KolFrosh,ISNULL(ListAllBackFrosh.Mon,0) As MonBack,ISNULL(ListAllBackFrosh.KolCount,0) As KolBack,ISNULL(ListAllKasri.Mon,0) As MonKasri,ISNULL(ListAllKasri.KolCount,0) As KolKari ,ISNULL(AllDisc.Darsad,0)  As Discount FROM (SELECT ROUND(SUM(KolCount),2) As KolCount,ISNULL(SUM(Mon-DarsadMon),0) As Mon FROM (SELECT KolCount,JozCount,Mon,DarsadMon  FROM ListFactorSell INNER JOIN KalaFactorSell ON ListFactorSell.IdFactor = KalaFactorSell.IdFactor WHERE (ListFactorSell.Stat =3 and ListFactorSell.Activ =1 AND ListFactorSell.IdVisitor IN(" & visitor & ")" & dat & ")) As ListFrosh ) As ListAllFrosh,(SELECT ROUND(SUM(KolCount),2) As KolCount,ISNULL(SUM(Mon-DarsadMon),0) As Mon FROM (SELECT KolCount,JozCount,Mon,DarsadMon FROM ListFactorBackSell INNER JOIN KalaFactorBackSell ON ListFactorBackSell.IdFactor = KalaFactorBackSell.IdFactor WHERE (ListFactorBackSell.Activ =1 AND ListFactorBackSell.IdVisitor IN(" & visitor & ")" & dat & ")) As ListBackFrosh ) As ListAllBackFrosh ,(SELECT ROUND(SUM(KolCount),2) As KolCount,ISNULL(SUM(Mon-DarsadMon),0) As Mon FROM (SELECT KolCount,JozCount,Mon,DarsadMon FROM KalaKasriFactor INNER JOIN ListKasriFactor ON KalaKasriFactor.IdFactor = ListKasriFactor.IdFactor INNER JOIN ListFactorSell ON ListKasriFactor.IdFactor = ListFactorSell.IdFactor  WHERE IdVisitor IN(" & visitor & ")" & dat2 & ") As ListKasri ) As ListAllKasri,(SELECT ISNULL(SUM(Darsad),0) As Darsad FROM (SELECT ISNULL(SUM(Discount),0) As Darsad FROM  ListFactorSell WHERE (ListFactorSell.Activ =1 AND ListFactorSell.IdVisitor IN(" & visitor & ") And ListFactorSell.Stat =3 AND Discount >0 " & dat & ") UNION ALL SELECT ISNULL(SUM(Discount) * -1,0) As Darsad FROM  ListFactorBackSell WHERE (ListFactorBackSell .Activ =1 AND ListFactorBackSell .IdVisitor IN(" & visitor & ") AND Discount >0 " & dat & ")  UNION ALL SELECT ISNULL(SUM(Discount),0) As Discount FROM  Get_Pay_Sanad WHERE Get_Pay_Sanad.[State] =0 AND Get_Pay_Sanad.Active  =1 AND Id IN (SELECT IdSanad FROM (SELECT IdSanad,COUNT(IdSanad ) As C_Count FROM PayLimitFrosh WHERE IdSanad IN (SELECT IdSanad FROM PayLimitFrosh WHERE IdFactor IN(SELECT IdFactor FROM ListFactorSell WHERE ListFactorSell.Activ =1 AND ListFactorSell.Stat =3 AND ListFactorSell.IdVisitor IN(" & visitor & ")" & dat & ")) GROUP BY IdSanad) As ListSanad WHERE C_Count =1)) AS AllDiscount) As AllDisc ) As InfoVisit"
                    If ChkGroup.Checked = True Then
                        FrmP.Lend = "DECLARE @Cal int SET @Cal=" & If(RdoMon.Checked = True, 0, If(RdoHajm.Checked = True, 1, 2)) & " SELECT NamTwo As GroupKala,nam As GroupNam,Mon,Kala,FroshK,KolCountK,DarsadFrosh,DarsadPorsant,MonPorsant FROM (SELECT  Idkala,IdGroup ,MAX(Mon) AS Mon,MAX(Kala) AS Kala,SUM(FroshK) AS FroshK,SUM(KolCountK) AS KolCountK,SUM(DarsadFrosh) AS DarsadFrosh,DarsadPorsant=CASE WHEN SUM(FroshK)<=0 THEN 0 ELSE ROUND(SUM(ROUND(ListPorsant.FroshK *ListPorsant.DarsadPorsant /100,0))*100/SUM(FroshK),2) END ,MonPorsant=SUM(ROUND(ListPorsant.FroshK *ListPorsant.DarsadPorsant /100,0)) FROM (SELECT Idkala ,IdGroup,Mon,Kala,FroshK,KolCountK,DarsadFrosh,DarsadPorsant=(SELECT ISNULL(SUM(Darsad),0)  As Darsad FROM (SELECT TOP 1 Darsad FROM  ListDarsad_G WHERE IdlinkKala =EndList.Id AND IdGroup =EndList.IdGroup AND Frosh <=EndList.DarsadFrosh ORDER By Frosh DESC) As DFrosh) FROM (SELECT Id ,Idkala ,Mon ,Kala ,IdVisitor ,IdGroup ,FroshK,KolCountK,DarsadFrosh=CASE WHEN @Cal=0 OR (@Cal=2 AND Mon>0) THEN CASE WHEN Mon<=0 THEN 0 ELSE ROUND(FroshK *100/Mon,2) END WHEN @Cal=1 OR (@Cal=2 AND Kala>0 AND Mon <=0) THEN CASE WHEN Kala<=0 THEN 0 ELSE ROUND(KolCountK *100/Kala ,2) END ELSE 0 END FROM (SELECT MAX(Id) AS Id,Idkala,MAX(Mon) As Mon,MAX(Kala) As Kala,MAX(IdVisitor) AS IdVisitor,IdGroup,SUM(FroshK) AS FroshK,SUM(KolCountK) AS KolCountK FROM (SELECT GroupKala,Id,Idkala,Mon,Kala,IdVisitor,IdGroup,FroshK=(SELECT ISNULL(ListAllFrosh.Mon,0) -ISNULL(ListAllBackFrosh.Mon,0)-ISNULL(ListAllKasri.Mon,0) As EndMon FROM (SELECT ISNULL(SUM(Mon),0) As Mon FROM (SELECT Mon-DarsadMon As Mon FROM KalaFactorSell INNER JOIN ListFactorSell ON KalaFactorSell.IdFactor = ListFactorSell.IdFactor WHERE (ListFactorSell.Stat =3 and ListFactorSell.Activ =1 AND ListFactorSell.IdVisitor IN(" & visitor & ") AND KalaFactorSell.IdKala =ListGoal.idK " & dat & " AND IdName IN (SELECT Id FROM Define_People WHERE Define_People.IdGroup=ListGoal .IdGroup AND Define_People.ChkIdGroup ='True'))) As ListFrosh ) As ListAllFrosh,(SELECT ISNULL(SUM(Mon),0) As Mon FROM (SELECT Mon-DarsadMon As Mon FROM KalaFactorBackSell INNER JOIN ListFactorBackSell ON KalaFactorBackSell.IdFactor = ListFactorBackSell.IdFactor WHERE (ListFactorBackSell.Activ =1 AND ListFactorBackSell.IdVisitor IN(" & visitor & ") AND KalaFactorBackSell.IdKala =ListGoal.idK " & dat & " AND IdName IN (SELECT Id FROM Define_People WHERE Define_People.IdGroup=ListGoal .IdGroup AND Define_People.ChkIdGroup ='True'))) As ListBackFrosh ) As ListAllBackFrosh ,(SELECT ISNULL(SUM(Mon),0) As Mon FROM (SELECT Mon-DarsadMon As Mon FROM KalaKasriFactor INNER JOIN ListKasriFactor ON KalaKasriFactor.IdFactor = ListKasriFactor.IdFactor INNER JOIN ListFactorSell ON ListKasriFactor.IdFactor = ListFactorSell.IdFactor  WHERE IdVisitor IN(" & visitor & ") AND KalaKasriFactor.IdR =ListGoal.idK " & dat2 & " AND IdName IN (SELECT Id FROM Define_People WHERE Define_People.IdGroup=ListGoal .IdGroup AND Define_People.ChkIdGroup ='True')) As ListKasri ) As ListAllKasri),KolCountK=CASE WHEN @Cal=0 THEN 0 WHEN @Cal=1 OR (@Cal=2 AND Kala>0 AND Mon <=0) THEN (SELECT ISNULL(ListAllFrosh.KolCount,0) -ISNULL(ListAllBackFrosh.KolCount,0)-ISNULL(ListAllKasri.KolCount,0) As KolCountK FROM (SELECT ISNULL(SUM(KolCount),0) As KolCount FROM (SELECT KolCount  FROM KalaFactorSell INNER JOIN ListFactorSell ON ListFactorSell.IdFactor = KalaFactorSell.IdFactor WHERE (ListFactorSell.Stat =3 and ListFactorSell.Activ =1 AND ListFactorSell.IdVisitor IN(" & visitor & ") AND KalaFactorSell.IdKala =ListGoal.idK " & dat & " AND IdName IN (SELECT Id FROM Define_People WHERE Define_People.IdGroup=ListGoal.IdGroup AND Define_People.ChkIdGroup ='True'))) As ListFrosh ) As ListAllFrosh,(SELECT ISNULL(SUM(KolCount),0) As KolCount FROM (SELECT KolCount  FROM KalaFactorBackSell INNER JOIN ListFactorBackSell ON ListFactorBackSell.IdFactor = KalaFactorBackSell.IdFactor  WHERE (ListFactorBackSell.Activ =1 AND ListFactorBackSell.IdVisitor IN(" & visitor & ") AND KalaFactorBackSell.IdKala =ListGoal.idK " & dat & " AND IdName IN (SELECT Id FROM Define_People WHERE Define_People.IdGroup=ListGoal.IdGroup AND Define_People.ChkIdGroup ='True'))) As ListBackFrosh ) As ListAllBackFrosh ,(SELECT ISNULL(SUM(KolCount),0) As KolCount FROM (SELECT KolCount  FROM KalaKasriFactor INNER JOIN ListKasriFactor ON KalaKasriFactor.IdFactor = ListKasriFactor.IdFactor INNER JOIN ListFactorSell ON ListKasriFactor.IdFactor = ListFactorSell.IdFactor  WHERE IdVisitor IN(" & visitor & ") AND KalaKasriFactor.IdR =ListGoal.idK  " & dat2 & " AND IdName IN (SELECT Id FROM Define_People WHERE Define_People.IdGroup=ListGoal .IdGroup AND Define_People.ChkIdGroup ='True')) As ListKasri ) As ListAllKasri) ELSE 0 END FROM (SELECT  DISTINCT Define_TwoGroup.NamTwo As GroupKala,Listkala_G.Id,Listkala_G.Idkala,Listkala_G.Mon,Listkala_G.Kala,Listkala_G.IdLinkVisitor As IdVisitor,ListDarsad_G.IdGroup,Define_Kala.Id AS IdK FROM  Listkala_G INNER JOIN Define_TwoGroup ON Listkala_G.Idkala = Define_TwoGroup.Id INNER JOIN ListDarsad_G ON Listkala_G.Id = ListDarsad_G.IdlinkKala INNER JOIN Define_Kala ON Define_Kala.IdCodeTwo =Listkala_G.Idkala WHERE IdLinkVisitor =" & CmbBox.SelectedValue & ") As ListGoal)As ListGoal2 GROUP By Idkala,IdGroup ) As ListFrosh) As EndList) As ListPorsant GROUP BY Idkala,IdGroup) As ListPorsantEnd INNER JOIN Define_TwoGroup ON Define_TwoGroup.Id =ListPorsantEnd.Idkala INNER JOIN Define_Group_P ON Define_Group_P.Id =ListPorsantEnd.IdGroup ORDER BY GroupKala"
                        FrmP.IdFactor = "DECLARE @Cal int SET @Cal=" & If(RdoMon.Checked = True, 0, If(RdoHajm.Checked = True, 1, 2)) & " SELECT Nam,FroshK ,KolCountK,Darsad,Porsant=ROUND(FroshK *Darsad /100,0)FROM(SELECT Nam,Darsad,FroshK=(SELECT ISNULL(ListAllFrosh.Mon,0) -ISNULL(ListAllBackFrosh.Mon,0)-ISNULL(ListAllKasri.Mon,0) As EndMon FROM (SELECT ISNULL(SUM(Mon),0) As Mon FROM (SELECT Mon-DarsadMon AS Mon FROM KalaFactorSell INNER JOIN ListFactorSell ON ListFactorSell.IdFactor = KalaFactorSell.IdFactor WHERE (ListFactorSell.Stat =3 and ListFactorSell.Activ =1 AND ListFactorSell.IdVisitor IN(" & visitor & ") AND KalaFactorSell.IdKala NOT IN (SELECT Id  FROM Define_Kala WHERE IdCodeTwo IN (SELECT  Idkala FROM Listkala_G WHERE IdLinkVisitor =ListOder.IdVisitor)) AND ListFactorSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListOder.IdGroup  AND ChkIdGroup ='True') " & dat & ")) As ListFrosh ) As ListAllFrosh,(SELECT ISNULL(SUM(Mon),0) As Mon FROM (SELECT Mon-DarsadMon AS Mon FROM KalaFactorBackSell INNER JOIN ListFactorBackSell ON ListFactorBackSell.IdFactor = KalaFactorBackSell.IdFactor WHERE (ListFactorBackSell.Activ =1 AND ListFactorBackSell.IdVisitor IN(" & visitor & ") AND KalaFactorBackSell.IdKala NOT IN (SELECT Id  FROM Define_Kala WHERE IdCodeTwo IN (SELECT  Idkala FROM Listkala_G WHERE IdLinkVisitor =ListOder.IdVisitor)) AND ListFactorBackSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListOder.IdGroup  AND ChkIdGroup ='True') " & dat & ")) As ListBackFrosh ) As ListAllBackFrosh ,(SELECT ISNULL(SUM(Mon),0) As Mon FROM (SELECT Mon-DarsadMon AS Mon FROM KalaKasriFactor INNER JOIN ListKasriFactor ON KalaKasriFactor.IdFactor = ListKasriFactor.IdFactor INNER JOIN ListFactorSell ON ListKasriFactor.IdFactor = ListFactorSell.IdFactor  WHERE IdVisitor IN(" & visitor & ") AND KalaKasriFactor.IdR NOT IN (SELECT Id  FROM Define_Kala WHERE IdCodeTwo IN (SELECT  Idkala FROM Listkala_G WHERE IdLinkVisitor =ListOder.IdVisitor)) AND ListFactorSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListOder.IdGroup  AND ChkIdGroup ='True') " & dat2 & ") As ListKasri ) As ListAllKasri),KolCountK=CASE WHEN @Cal=1 THEN (SELECT ISNULL(ListAllFrosh.KolCount,0) -ISNULL(ListAllBackFrosh.KolCount,0)-ISNULL(ListAllKasri.KolCount,0) As EndKolCount FROM (SELECT ISNULL(SUM(KolCount),0) As KolCount FROM (SELECT KolCount  FROM KalaFactorSell INNER JOIN ListFactorSell ON ListFactorSell.IdFactor = KalaFactorSell.IdFactor WHERE (ListFactorSell.Stat =3 and ListFactorSell.Activ =1 AND ListFactorSell.IdVisitor IN(" & visitor & ") AND KalaFactorSell.IdKala NOT IN (SELECT Id  FROM Define_Kala WHERE IdCodeTwo IN (SELECT  Idkala FROM Listkala_G WHERE IdLinkVisitor =ListOder.IdVisitor)) AND ListFactorSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListOder.IdGroup  AND ChkIdGroup ='True') " & dat & ")) As ListFrosh ) As ListAllFrosh,(SELECT ISNULL(SUM(KolCount),0) As KolCount FROM (SELECT KolCount FROM KalaFactorBackSell INNER JOIN ListFactorBackSell ON ListFactorBackSell.IdFactor = KalaFactorBackSell.IdFactor WHERE (ListFactorBackSell.Activ =1 AND ListFactorBackSell.IdVisitor IN(" & visitor & ") AND KalaFactorBackSell.IdKala NOT IN (SELECT Id  FROM Define_Kala WHERE IdCodeTwo IN (SELECT  Idkala FROM Listkala_G WHERE IdLinkVisitor =ListOder.IdVisitor)) AND ListFactorBackSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListOder.IdGroup  AND ChkIdGroup ='True') " & dat & ")) As ListBackFrosh ) As ListAllBackFrosh ,(SELECT ISNULL(SUM(KolCount),0) As KolCount FROM (SELECT KolCount FROM KalaKasriFactor INNER JOIN ListKasriFactor ON KalaKasriFactor.IdFactor = ListKasriFactor.IdFactor INNER JOIN ListFactorSell ON ListKasriFactor.IdFactor = ListFactorSell.IdFactor  WHERE IdVisitor IN(" & visitor & ") AND KalaKasriFactor.IdR NOT IN (SELECT Id  FROM Define_Kala WHERE IdCodeTwo IN (SELECT  Idkala FROM Listkala_G WHERE IdLinkVisitor =ListOder.IdVisitor)) AND ListFactorSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListOder.IdGroup  AND ChkIdGroup ='True') " & dat2 & ") As ListKasri ) As ListAllKasri) ELSE 0 END FROM (SELECT ListOrderDarsad_G.Darsad,ListOrderDarsad_G.IdGroup ,ListOrderDarsad_G.IdLinkVisitor AS IdVisitor,Define_Group_P.nam FROM   ListOrderDarsad_G INNER JOIN Define_Group_P  ON ListOrderDarsad_G.IdGroup  = Define_Group_P.Id WHERE  IdLinkVisitor =" & CmbBox.SelectedValue & ") As ListOder) As ListAllOder"
                        If RdoHybrid.Checked = True Then
                            FrmP.CHoose = "GOALTWO"
                        ElseIf RdoHajm.Checked = True Then
                            FrmP.CHoose = "GOALTWO_HAJM"
                        ElseIf RdoMon.Checked = True Then
                            FrmP.CHoose = "GOALTWO_MON"
                        End If
                    Else
                        FrmP.Lend = "DECLARE @Cal int SET @Cal=" & If(RdoMon.Checked = True, 0, If(RdoHajm.Checked = True, 1, 2)) & " SELECT NamTwo As GroupKala,Mon,Kala,FroshK,KolCountK,DarsadFrosh,DarsadPorsant,MonPorsant FROM (SELECT Idkala ,MAX(Mon) AS Mon,MAX(Kala) AS Kala,SUM(FroshK) AS FroshK,SUM(KolCountK) AS KolCountK,SUM(DarsadFrosh) AS DarsadFrosh,DarsadPorsant=CASE WHEN SUM(FroshK)<=0 THEN 0 ELSE ROUND(SUM(ROUND(ListPorsant.FroshK *ListPorsant.DarsadPorsant /100,0))*100/SUM(FroshK),2) END,MonPorsant=SUM(ROUND(ListPorsant.FroshK *ListPorsant.DarsadPorsant /100,0)) FROM (SELECT Idkala ,Mon,Kala,FroshK,KolCountK,DarsadFrosh,DarsadPorsant=(SELECT ISNULL(SUM(Darsad),0)  As Darsad FROM (SELECT TOP 1 Darsad FROM  ListDarsad_G WHERE IdlinkKala =EndList.Id AND IdGroup =EndList.IdGroup AND Frosh <=EndList.DarsadFrosh ORDER By Frosh DESC) As DFrosh) FROM (SELECT Id,Idkala,Mon,Kala,IdVisitor,IdGroup ,FroshK,KolCountK,DarsadFrosh=CASE WHEN @Cal=0 OR (@Cal=2 AND Mon>0) THEN CASE WHEN Mon<=0 THEN 0 ELSE ROUND(FroshK *100/Mon,2) END WHEN @Cal=1 OR (@Cal=2 AND Kala>0 AND Mon <=0) THEN CASE WHEN Kala<=0 THEN 0 ELSE ROUND(KolCountK *100/Kala ,2) END ELSE 0 END FROM (SELECT MAX(Id) AS Id,Idkala,MAX(Mon) As Mon,MAX(Kala) As Kala,MAX(IdVisitor) AS IdVisitor,IdGroup,SUM(FroshK) AS FroshK,SUM(KolCountK) AS KolCountK FROM (SELECT GroupKala,Id,Idkala,Mon,Kala,IdVisitor,IdGroup,FroshK=(SELECT ISNULL(ListAllFrosh.Mon,0) -ISNULL(ListAllBackFrosh.Mon,0)-ISNULL(ListAllKasri.Mon,0) As EndMon FROM (SELECT ISNULL(SUM(Mon),0) As Mon FROM (SELECT Mon-DarsadMon As Mon FROM KalaFactorSell INNER JOIN ListFactorSell ON KalaFactorSell.IdFactor = ListFactorSell.IdFactor WHERE (ListFactorSell.Stat =3 and ListFactorSell.Activ =1 AND ListFactorSell.IdVisitor IN(" & visitor & ") AND KalaFactorSell.IdKala =ListGoal.idK " & dat & " AND IdName IN (SELECT Id FROM Define_People WHERE Define_People.IdGroup=ListGoal .IdGroup AND Define_People.ChkIdGroup ='True'))) As ListFrosh ) As ListAllFrosh,(SELECT ISNULL(SUM(Mon),0) As Mon FROM (SELECT Mon-DarsadMon As Mon FROM KalaFactorBackSell INNER JOIN ListFactorBackSell ON KalaFactorBackSell.IdFactor = ListFactorBackSell.IdFactor WHERE (ListFactorBackSell.Activ =1 AND ListFactorBackSell.IdVisitor IN(" & visitor & ") AND KalaFactorBackSell.IdKala =ListGoal.idK " & dat & " AND IdName IN (SELECT Id FROM Define_People WHERE Define_People.IdGroup=ListGoal.IdGroup AND Define_People.ChkIdGroup ='True'))) As ListBackFrosh ) As ListAllBackFrosh ,(SELECT ISNULL(SUM(Mon),0) As Mon FROM (SELECT Mon-DarsadMon As Mon FROM KalaKasriFactor INNER JOIN ListKasriFactor ON KalaKasriFactor.IdFactor = ListKasriFactor.IdFactor INNER JOIN ListFactorSell ON ListKasriFactor.IdFactor = ListFactorSell.IdFactor  WHERE IdVisitor IN(" & visitor & ") AND KalaKasriFactor.IdR =ListGoal.idK " & dat2 & " AND IdName IN (SELECT Id FROM Define_People WHERE Define_People.IdGroup=ListGoal .IdGroup AND Define_People.ChkIdGroup ='True')) As ListKasri ) As ListAllKasri),KolCountK=CASE WHEN @Cal=0 THEN 0 WHEN @Cal=1 OR (@Cal=2 AND Kala>0 AND Mon <=0) THEN (SELECT ISNULL(ListAllFrosh.KolCount,0) -ISNULL(ListAllBackFrosh.KolCount,0)-ISNULL(ListAllKasri.KolCount,0) As KolCountK FROM (SELECT ISNULL(SUM(KolCount),0) As KolCount FROM (SELECT KolCount  FROM KalaFactorSell INNER JOIN ListFactorSell ON ListFactorSell.IdFactor = KalaFactorSell.IdFactor WHERE (ListFactorSell.Stat =3 and ListFactorSell.Activ =1 AND ListFactorSell.IdVisitor IN(" & visitor & ") AND KalaFactorSell.IdKala =ListGoal.idK " & dat & " AND IdName IN (SELECT Id FROM Define_People WHERE Define_People.IdGroup=ListGoal .IdGroup AND Define_People.ChkIdGroup ='True'))) As ListFrosh ) As ListAllFrosh,(SELECT ISNULL(SUM(KolCount),0) As KolCount FROM (SELECT KolCount  FROM KalaFactorBackSell INNER JOIN ListFactorBackSell ON ListFactorBackSell.IdFactor = KalaFactorBackSell.IdFactor  WHERE (ListFactorBackSell.Activ =1 AND ListFactorBackSell.IdVisitor IN(" & visitor & ") AND KalaFactorBackSell.IdKala =ListGoal.idK " & dat & " AND IdName IN (SELECT Id FROM Define_People WHERE Define_People.IdGroup=ListGoal.IdGroup AND Define_People.ChkIdGroup ='True'))) As ListBackFrosh ) As ListAllBackFrosh ,(SELECT ISNULL(SUM(KolCount),0) As KolCount FROM (SELECT KolCount  FROM KalaKasriFactor INNER JOIN ListKasriFactor ON KalaKasriFactor.IdFactor = ListKasriFactor.IdFactor INNER JOIN ListFactorSell ON ListKasriFactor.IdFactor = ListFactorSell.IdFactor  WHERE IdVisitor IN(" & visitor & ") AND KalaKasriFactor.IdR =ListGoal.idK " & dat2 & " AND IdName IN (SELECT Id FROM Define_People WHERE Define_People.IdGroup=ListGoal .IdGroup AND Define_People.ChkIdGroup ='True')) As ListKasri ) As ListAllKasri) ELSE 0 END FROM (SELECT  DISTINCT Define_TwoGroup.NamTwo As GroupKala,Listkala_G.Id,Listkala_G.Idkala,Listkala_G.Mon,Listkala_G.Kala,Listkala_G.IdLinkVisitor As IdVisitor,ListDarsad_G.IdGroup,Define_Kala.Id AS IdK FROM  Listkala_G INNER JOIN Define_TwoGroup ON Listkala_G.Idkala = Define_TwoGroup.Id INNER JOIN ListDarsad_G ON Listkala_G.Id = ListDarsad_G.IdlinkKala INNER JOIN Define_Kala ON Define_Kala.IdCodeTwo =Listkala_G.Idkala WHERE IdLinkVisitor =" & CmbBox.SelectedValue & ") As ListGoal)As ListGoal2 GROUP By Idkala,IdGroup ) As ListFrosh) As EndList) As ListPorsant GROUP BY Idkala) As ListPorsantEnd INNER JOIN Define_TwoGroup ON Define_TwoGroup.Id =ListPorsantEnd.Idkala ORDER BY GroupKala"
                        FrmP.IdFactor = "DECLARE @Cal int SET @Cal=" & If(RdoMon.Checked = True, 0, If(RdoHajm.Checked = True, 1, 2)) & " SELECT SUM(FroshK) AS FroshK,SUM(KolCountK) AS KolCountK,Darsad=CASE WHEN SUM(FroshK)<=0 THEN 0 ELSE ROUND(SUM(ROUND(FroshK *Darsad /100,0))*100/SUM(FroshK),2) END,Porsant=SUM(ROUND(FroshK *Darsad /100,0)) FROM(SELECT Nam,Darsad,FroshK=(SELECT ISNULL(ListAllFrosh.Mon,0) -ISNULL(ListAllBackFrosh.Mon,0)-ISNULL(ListAllKasri.Mon,0) As EndMon FROM (SELECT ISNULL(SUM(Mon),0) As Mon FROM (SELECT Mon-DarsadMon AS Mon FROM KalaFactorSell INNER JOIN ListFactorSell ON ListFactorSell.IdFactor = KalaFactorSell.IdFactor WHERE (ListFactorSell.Stat =3 and ListFactorSell.Activ =1 AND ListFactorSell.IdVisitor IN(" & visitor & ") AND KalaFactorSell.IdKala NOT IN (SELECT Id  FROM Define_Kala WHERE IdCodeTwo IN (SELECT  Idkala FROM Listkala_G WHERE IdLinkVisitor =ListOder.IdVisitor)) AND ListFactorSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListOder.IdGroup  AND ChkIdGroup ='True') " & dat & ")) As ListFrosh ) As ListAllFrosh,(SELECT ISNULL(SUM(Mon),0) As Mon FROM (SELECT Mon-DarsadMon AS Mon FROM KalaFactorBackSell INNER JOIN ListFactorBackSell ON ListFactorBackSell.IdFactor = KalaFactorBackSell.IdFactor WHERE (ListFactorBackSell.Activ =1 AND ListFactorBackSell.IdVisitor IN(" & visitor & ") AND KalaFactorBackSell.IdKala NOT IN (SELECT Id  FROM Define_Kala WHERE IdCodeTwo IN (SELECT  Idkala FROM Listkala_G WHERE IdLinkVisitor =ListOder.IdVisitor)) AND ListFactorBackSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListOder.IdGroup  AND ChkIdGroup ='True') " & dat & ")) As ListBackFrosh ) As ListAllBackFrosh ,(SELECT ISNULL(SUM(Mon),0) As Mon FROM (SELECT Mon-DarsadMon AS Mon FROM KalaKasriFactor INNER JOIN ListKasriFactor ON KalaKasriFactor.IdFactor = ListKasriFactor.IdFactor INNER JOIN ListFactorSell ON ListKasriFactor.IdFactor = ListFactorSell.IdFactor  WHERE IdVisitor IN(" & visitor & ") AND KalaKasriFactor.IdR NOT IN (SELECT Id  FROM Define_Kala WHERE IdCodeTwo IN (SELECT  Idkala FROM Listkala_G WHERE IdLinkVisitor =ListOder.IdVisitor)) AND ListFactorSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListOder.IdGroup  AND ChkIdGroup ='True') " & dat2 & ") As ListKasri ) As ListAllKasri),KolCountK=CASE WHEN @Cal=1 THEN (SELECT ISNULL(ListAllFrosh.KolCount,0) -ISNULL(ListAllBackFrosh.KolCount,0)-ISNULL(ListAllKasri.KolCount,0) As EndKolCount FROM (SELECT ISNULL(SUM(KolCount),0) As KolCount FROM (SELECT KolCount  FROM KalaFactorSell INNER JOIN ListFactorSell ON ListFactorSell.IdFactor = KalaFactorSell.IdFactor WHERE (ListFactorSell.Stat =3 and ListFactorSell.Activ =1 AND ListFactorSell.IdVisitor IN(" & visitor & ") AND KalaFactorSell.IdKala NOT IN (SELECT Id  FROM Define_Kala WHERE IdCodeTwo IN (SELECT  Idkala FROM Listkala_G WHERE IdLinkVisitor =ListOder.IdVisitor)) AND ListFactorSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListOder.IdGroup  AND ChkIdGroup ='True') " & dat & ")) As ListFrosh ) As ListAllFrosh,(SELECT ISNULL(SUM(KolCount),0) As KolCount FROM (SELECT KolCount FROM KalaFactorBackSell INNER JOIN ListFactorBackSell ON ListFactorBackSell.IdFactor = KalaFactorBackSell.IdFactor WHERE (ListFactorBackSell.Activ =1 AND ListFactorBackSell.IdVisitor IN(" & visitor & ") AND KalaFactorBackSell.IdKala NOT IN (SELECT Id  FROM Define_Kala WHERE IdCodeTwo IN (SELECT  Idkala FROM Listkala_G WHERE IdLinkVisitor =ListOder.IdVisitor)) AND ListFactorBackSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListOder.IdGroup  AND ChkIdGroup ='True') " & dat & ")) As ListBackFrosh ) As ListAllBackFrosh ,(SELECT ISNULL(SUM(KolCount),0) As KolCount FROM (SELECT KolCount FROM KalaKasriFactor INNER JOIN ListKasriFactor ON KalaKasriFactor.IdFactor = ListKasriFactor.IdFactor INNER JOIN ListFactorSell ON ListKasriFactor.IdFactor = ListFactorSell.IdFactor  WHERE IdVisitor IN(" & visitor & ") AND KalaKasriFactor.IdR NOT IN (SELECT Id  FROM Define_Kala WHERE IdCodeTwo IN (SELECT  Idkala FROM Listkala_G WHERE IdLinkVisitor =ListOder.IdVisitor)) AND ListFactorSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListOder.IdGroup  AND ChkIdGroup ='True') " & dat2 & ") As ListKasri ) As ListAllKasri) ELSE 0 END FROM (SELECT ListOrderDarsad_G.Darsad,ListOrderDarsad_G.IdGroup ,ListOrderDarsad_G.IdLinkVisitor AS IdVisitor,Define_Group_P.nam FROM   ListOrderDarsad_G INNER JOIN Define_Group_P  ON ListOrderDarsad_G.IdGroup  = Define_Group_P.Id WHERE  IdLinkVisitor =" & CmbBox.SelectedValue & ") As ListOder) As ListAllOder"
                        If RdoHybrid.Checked = True Then
                            FrmP.CHoose = "GOALTWO_G"
                        ElseIf RdoHajm.Checked = True Then
                            FrmP.CHoose = "GOALTWO_G_HAJM"
                        ElseIf RdoMon.Checked = True Then
                            FrmP.CHoose = "GOALTWO_G_MON"
                        End If
                    End If
                ElseIf RdoKala.Checked = True Then
                    FrmP.PrintSQl = "SELECT MonFrosh,KolFrosh,MonBack,KolBack,MonKasri,KolKari,Discount ,(MonFrosh - MonBack - MonKasri) As EndMon,(KolFrosh - KolBack - KolKari) As EndKol,FixMon=(SELECT ISNULL(SUM(Mon),0) FROM Define_Visitor WHERE Id IN (" & visitor & ")) FROM (SELECT ISNULL(ListAllFrosh.Mon,0) As MonFrosh,ISNULL(ListAllFrosh.KolCount,0) As KolFrosh,ISNULL(ListAllBackFrosh.Mon,0) As MonBack,ISNULL(ListAllBackFrosh.KolCount,0) As KolBack,ISNULL(ListAllKasri.Mon,0) As MonKasri,ISNULL(ListAllKasri.KolCount,0) As KolKari ,ISNULL(AllDisc.Darsad,0)  As Discount FROM (SELECT ROUND(SUM(KolCount),2) As KolCount,ISNULL(SUM(Mon-DarsadMon),0) As Mon FROM (SELECT KolCount,JozCount,Mon,DarsadMon  FROM ListFactorSell INNER JOIN KalaFactorSell ON ListFactorSell.IdFactor = KalaFactorSell.IdFactor WHERE (ListFactorSell.Stat =3 and ListFactorSell.Activ =1 AND ListFactorSell.IdVisitor IN(" & visitor & ")" & dat & ")) As ListFrosh ) As ListAllFrosh,(SELECT ROUND(SUM(KolCount),2) As KolCount,ISNULL(SUM(Mon-DarsadMon),0) As Mon FROM (SELECT KolCount,JozCount,Mon,DarsadMon FROM ListFactorBackSell INNER JOIN KalaFactorBackSell ON ListFactorBackSell.IdFactor = KalaFactorBackSell.IdFactor WHERE (ListFactorBackSell.Activ =1 AND ListFactorBackSell.IdVisitor IN(" & visitor & ")" & dat & ")) As ListBackFrosh ) As ListAllBackFrosh ,(SELECT ROUND(SUM(KolCount),2) As KolCount,ISNULL(SUM(Mon-DarsadMon),0) As Mon FROM (SELECT KolCount,JozCount,Mon,DarsadMon FROM KalaKasriFactor INNER JOIN ListKasriFactor ON KalaKasriFactor.IdFactor = ListKasriFactor.IdFactor INNER JOIN ListFactorSell ON ListKasriFactor.IdFactor = ListFactorSell.IdFactor  WHERE IdVisitor IN(" & visitor & ")" & dat2 & ") As ListKasri ) As ListAllKasri,(SELECT ISNULL(SUM(Darsad),0) As Darsad FROM (SELECT ISNULL(SUM(Discount),0) As Darsad FROM  ListFactorSell WHERE (ListFactorSell.Activ =1 AND ListFactorSell.IdVisitor IN (" & visitor & ") And ListFactorSell.Stat =3 AND Discount >0 " & dat & ") UNION ALL SELECT ISNULL(SUM(Discount) * -1,0) As Darsad FROM  ListFactorBackSell WHERE (ListFactorBackSell .Activ =1 AND ListFactorBackSell .IdVisitor IN (" & visitor & ") AND Discount >0 " & dat & ")  UNION ALL SELECT ISNULL(SUM(Discount),0) As Discount FROM  Get_Pay_Sanad WHERE Get_Pay_Sanad.[State] =0 AND Get_Pay_Sanad.Active  =1 AND Id IN (SELECT IdSanad FROM (SELECT IdSanad,COUNT(IdSanad ) As C_Count FROM PayLimitFrosh WHERE IdSanad IN (SELECT IdSanad FROM PayLimitFrosh WHERE IdFactor IN(SELECT IdFactor FROM ListFactorSell WHERE ListFactorSell.Activ =1 AND ListFactorSell.Stat =3 AND ListFactorSell.IdVisitor IN(" & visitor & ")" & dat & ")) GROUP BY IdSanad) As ListSanad WHERE C_Count =1)) AS AllDiscount) As AllDisc ) As InfoVisit"
                    If ChkGroup.Checked = True Then
                        FrmP.Lend = "DECLARE @Cal int SET @Cal=" & If(RdoMon.Checked = True, 0, If(RdoHajm.Checked = True, 1, 2)) & " SELECT  GroupKala,Mon,Kala,GroupNam ,FroshK,KolCountK,DarsadFrosh,DarsadPorsant,MonPorsant=ROUND(ListPorsant.FroshK *ListPorsant.DarsadPorsant /100,0) FROM(SELECT GroupKala,Mon,Kala,GroupNam ,FroshK,KolCountK,DarsadFrosh,DarsadPorsant=(SELECT ISNULL(SUM(Darsad),0)  As Darsad FROM (SELECT TOP 1 Darsad FROM  ListDarsad WHERE IdlinkKala =EndList.Id AND IdGroup =EndList.IdGroup AND Frosh <=EndList.DarsadFrosh ORDER By Frosh DESC) As DFrosh) FROM (SELECT GroupKala,Id,Idkala,Mon,Kala,IdVisitor,IdGroup,GroupNam,FroshK,KolCountK,DarsadFrosh=CASE WHEN @Cal=0 OR (@Cal=2 AND Mon>0) THEN CASE WHEN Mon<=0 THEN 0 ELSE ROUND(FroshK *100/Mon,2) END WHEN @Cal=1 OR (@Cal=2 AND Kala>0 AND Mon <=0) THEN CASE WHEN Kala<=0 THEN 0 ELSE ROUND(KolCountK *100/Kala ,2) END ELSE 0 END  FROM (SELECT GroupKala ,Id ,Idkala ,Mon ,Kala ,IdVisitor ,IdGroup ,GroupNam,FroshK=(SELECT ISNULL(ListAllFrosh.Mon,0) -ISNULL(ListAllBackFrosh.Mon,0)-ISNULL(ListAllKasri.Mon,0) As EndMon FROM (SELECT ISNULL(SUM(Mon),0) As Mon FROM (SELECT Mon-DarsadMon As Mon FROM KalaFactorSell INNER JOIN ListFactorSell ON ListFactorSell.IdFactor = KalaFactorSell.IdFactor WHERE (ListFactorSell.Stat =3 and ListFactorSell.Activ =1 AND ListFactorSell.IdVisitor IN(" & visitor & ") AND KalaFactorSell.IdKala IN (SELECT Id  FROM Define_Kala WHERE Id =ListGoal.Idkala) AND ListFactorSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListGoal.IdGroup  AND ChkIdGroup ='True') " & dat & ")) As ListFrosh ) As ListAllFrosh,(SELECT ISNULL(SUM(Mon),0) As Mon FROM (SELECT Mon-DarsadMon As Mon FROM KalaFactorBackSell INNER JOIN ListFactorBackSell ON ListFactorBackSell.IdFactor = KalaFactorBackSell.IdFactor WHERE (ListFactorBackSell.Activ =1 AND ListFactorBackSell.IdVisitor IN(" & visitor & ") AND KalaFactorBackSell.IdKala IN (SELECT Id  FROM Define_Kala WHERE Id =ListGoal.Idkala) AND ListFactorBackSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListGoal.IdGroup  AND ChkIdGroup ='True') " & dat & ")) As ListBackFrosh ) As ListAllBackFrosh ,(SELECT ISNULL(SUM(Mon),0) As Mon FROM (SELECT Mon-DarsadMon As Mon FROM KalaKasriFactor INNER JOIN ListKasriFactor ON KalaKasriFactor.IdFactor = ListKasriFactor.IdFactor INNER JOIN ListFactorSell ON ListKasriFactor.IdFactor = ListFactorSell.IdFactor  WHERE IdVisitor IN(" & visitor & ") AND KalaKasriFactor.IdR  IN (SELECT Id  FROM Define_Kala WHERE Id =ListGoal.Idkala) AND ListFactorSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListGoal.IdGroup  AND ChkIdGroup ='True') " & dat2 & ") As ListKasri ) As ListAllKasri),KolCountK=CASE WHEN @Cal=1 OR (@Cal=2 AND Kala>0 AND Mon <=0) THEN (SELECT ISNULL(ListAllFrosh.KolCount,0) -ISNULL(ListAllBackFrosh.KolCount,0)-ISNULL(ListAllKasri.KolCount,0) As KolCountK FROM (SELECT ISNULL(SUM(KolCount),0) As KolCount FROM (SELECT KolCount  FROM KalaFactorSell INNER JOIN ListFactorSell ON ListFactorSell.IdFactor = KalaFactorSell.IdFactor WHERE (ListFactorSell.Stat =3 and ListFactorSell.Activ =1 AND ListFactorSell.IdVisitor IN(" & visitor & ") AND KalaFactorSell.IdKala IN (SELECT Id  FROM Define_Kala WHERE Id =ListGoal.Idkala) AND ListFactorSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListGoal.IdGroup  AND ChkIdGroup ='True') " & dat & ")) As ListFrosh ) As ListAllFrosh,(SELECT ISNULL(SUM(KolCount),0) As KolCount FROM (SELECT KolCount  FROM KalaFactorBackSell INNER JOIN ListFactorBackSell ON ListFactorBackSell.IdFactor = KalaFactorBackSell.IdFactor WHERE (ListFactorBackSell.Activ =1 AND ListFactorBackSell.IdVisitor IN(" & visitor & ") AND KalaFactorBackSell.IdKala IN (SELECT Id  FROM Define_Kala WHERE Id=ListGoal.Idkala) AND ListFactorBackSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListGoal.IdGroup  AND ChkIdGroup ='True') " & dat & ")) As ListBackFrosh ) As ListAllBackFrosh ,(SELECT ISNULL(SUM(KolCount),0) As KolCount FROM (SELECT KolCount  FROM KalaKasriFactor INNER JOIN ListKasriFactor ON KalaKasriFactor.IdFactor = ListKasriFactor.IdFactor INNER JOIN ListFactorSell ON ListKasriFactor.IdFactor = ListFactorSell.IdFactor  WHERE IdVisitor IN(" & visitor & ") AND KalaKasriFactor.IdR  IN (SELECT Id  FROM Define_Kala WHERE Id =ListGoal.Idkala) AND ListFactorSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListGoal.IdGroup  AND ChkIdGroup ='True') " & dat2 & ") As ListKasri ) As ListAllKasri) WHEN @Cal=0 THEN 0 ELSE 0 END FROM (SELECT  DISTINCT Define_Kala.Nam As GroupKala,Listkala.Id ,Listkala.Idkala,Listkala.Mon,Listkala.Kala,Listkala.IdLinkVisitor As IdVisitor,ListDarsad.IdGroup,Define_Group_P.nam As GroupNam FROM  Listkala INNER JOIN Define_Kala ON Listkala.Idkala = Define_Kala.Id INNER JOIN ListDarsad ON Listkala.Id = ListDarsad.IdlinkKala INNER JOIN Define_Group_P ON ListDarsad.IdGroup = Define_Group_P.Id WHERE IdLinkVisitor =" & CmbBox.SelectedValue & ") As ListGoal) As ListFrosh) As EndList) As ListPorsant"
                        FrmP.IdFactor = "DECLARE @Cal int SET @Cal=" & If(RdoMon.Checked = True, 0, If(RdoHajm.Checked = True, 1, 2)) & " SELECT Nam,FroshK,KolCountK,Darsad,Porsant=ROUND(FroshK *Darsad /100,0) FROM (SELECT Nam,Darsad,FroshK=(SELECT ISNULL(ListAllFrosh.Mon,0) -ISNULL(ListAllBackFrosh.Mon,0)-ISNULL(ListAllKasri.Mon,0) As EndMon FROM (SELECT ISNULL(SUM(Mon),0) As Mon FROM (SELECT Mon-DarsadMon AS Mon  FROM KalaFactorSell INNER JOIN ListFactorSell ON ListFactorSell.IdFactor = KalaFactorSell.IdFactor WHERE (ListFactorSell.Stat =3 and ListFactorSell.Activ =1 AND ListFactorSell.IdVisitor IN(" & visitor & ") AND KalaFactorSell.IdKala NOT IN (SELECT Id  FROM Define_Kala WHERE Id IN (SELECT  Idkala FROM Listkala WHERE IdLinkVisitor =ListOder.IdVisitor)) AND ListFactorSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListOder.IdGroup  AND ChkIdGroup ='True') " & dat & ")) As ListFrosh ) As ListAllFrosh,(SELECT ISNULL(SUM(Mon),0) As Mon FROM (SELECT Mon-DarsadMon AS Mon FROM KalaFactorBackSell INNER JOIN ListFactorBackSell ON ListFactorBackSell.IdFactor = KalaFactorBackSell.IdFactor WHERE (ListFactorBackSell.Activ =1 AND ListFactorBackSell.IdVisitor IN(" & visitor & ") AND KalaFactorBackSell.IdKala NOT IN (SELECT Id  FROM Define_Kala WHERE Id IN (SELECT  Idkala FROM Listkala WHERE IdLinkVisitor =ListOder.IdVisitor)) AND ListFactorBackSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListOder.IdGroup  AND ChkIdGroup ='True') " & dat & ")) As ListBackFrosh ) As ListAllBackFrosh ,(SELECT ISNULL(SUM(Mon),0) As Mon FROM (SELECT Mon-DarsadMon AS Mon FROM KalaKasriFactor INNER JOIN ListKasriFactor ON KalaKasriFactor.IdFactor = ListKasriFactor.IdFactor INNER JOIN ListFactorSell ON ListKasriFactor.IdFactor = ListFactorSell.IdFactor  WHERE IdVisitor IN(" & visitor & ") AND KalaKasriFactor.IdR NOT IN (SELECT Id  FROM Define_Kala WHERE Id IN (SELECT  Idkala FROM Listkala WHERE IdLinkVisitor =ListOder.IdVisitor)) AND ListFactorSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListOder.IdGroup  AND ChkIdGroup ='True') " & dat2 & ") As ListKasri ) As ListAllKasri),KolCountK=CASE WHEN @Cal=1 THEN (SELECT ISNULL(ListAllFrosh.KolCount,0) -ISNULL(ListAllBackFrosh.KolCount,0)-ISNULL(ListAllKasri.KolCount,0) As EndKolCount FROM (SELECT ISNULL(SUM(KolCount),0) As KolCount FROM (SELECT KolCount  FROM KalaFactorSell INNER JOIN ListFactorSell ON ListFactorSell.IdFactor = KalaFactorSell.IdFactor WHERE (ListFactorSell.Stat =3 and ListFactorSell.Activ =1 AND ListFactorSell.IdVisitor IN(" & visitor & ") AND KalaFactorSell.IdKala NOT IN (SELECT Id  FROM Define_Kala WHERE Id IN (SELECT  Idkala FROM Listkala  WHERE IdLinkVisitor =ListOder.IdVisitor)) AND ListFactorSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListOder.IdGroup  AND ChkIdGroup ='True') " & dat & ")) As ListFrosh ) As ListAllFrosh,(SELECT ISNULL(SUM(KolCount),0) As KolCount FROM (SELECT KolCount FROM KalaFactorBackSell INNER JOIN ListFactorBackSell ON ListFactorBackSell.IdFactor = KalaFactorBackSell.IdFactor WHERE (ListFactorBackSell.Activ =1 AND ListFactorBackSell.IdVisitor IN(" & visitor & ") AND KalaFactorBackSell.IdKala NOT IN (SELECT Id FROM Define_Kala WHERE Id IN (SELECT Idkala FROM Listkala WHERE IdLinkVisitor =ListOder.IdVisitor)) AND ListFactorBackSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListOder.IdGroup  AND ChkIdGroup ='True') " & dat & ")) As ListBackFrosh ) As ListAllBackFrosh ,(SELECT ISNULL(SUM(KolCount),0) As KolCount FROM (SELECT KolCount FROM KalaKasriFactor INNER JOIN ListKasriFactor ON KalaKasriFactor.IdFactor = ListKasriFactor.IdFactor INNER JOIN ListFactorSell ON ListKasriFactor.IdFactor = ListFactorSell.IdFactor  WHERE IdVisitor IN(" & visitor & ") AND KalaKasriFactor.IdR NOT IN (SELECT Id FROM Define_Kala WHERE Id IN (SELECT  Idkala FROM Listkala WHERE IdLinkVisitor =ListOder.IdVisitor)) AND ListFactorSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListOder.IdGroup  AND ChkIdGroup ='True') " & dat2 & ") As ListKasri ) As ListAllKasri) ELSE 0 END FROM(SELECT ListOrderDarsad.Darsad,ListOrderDarsad.IdGroup,ListOrderDarsad.IdLinkVisitor AS IdVisitor,Define_Group_P.nam FROM   ListOrderDarsad INNER JOIN Define_Group_P  ON ListOrderDarsad.IdGroup  = Define_Group_P.Id WHERE  IdLinkVisitor =" & CmbBox.SelectedValue & ") As ListOder) As ListAllOder"
                        If RdoHybrid.Checked = True Then
                            FrmP.CHoose = "GOALKALA"
                        ElseIf RdoHajm.Checked = True Then
                            FrmP.CHoose = "GOALKALA_HAJM"
                        ElseIf RdoMon.Checked = True Then
                            FrmP.CHoose = "GOALKALA_MON"
                        End If
                    Else
                        FrmP.Lend = "DECLARE @Cal int SET @Cal=" & If(RdoMon.Checked = True, 0, If(RdoHajm.Checked = True, 1, 2)) & " SELECT GroupKala ,MAX(Mon) AS Mon,MAX(Kala) AS Kala,SUM(FroshK) AS FroshK,SUM(KolCountK) AS KolCountK,SUM(DarsadFrosh) AS DarsadFrosh,DarsadPorsant=CASE WHEN SUM(FroshK)<=0 THEN 0 ELSE ROUND(SUM(ROUND(ListPorsant.FroshK *ListPorsant.DarsadPorsant /100,0))*100/SUM(FroshK),2) END,MonPorsant=SUM(ROUND(ListPorsant.FroshK *ListPorsant.DarsadPorsant /100,0)) FROM(SELECT GroupKala,Mon,Kala,GroupNam ,FroshK,KolCountK,DarsadFrosh,DarsadPorsant=(SELECT ISNULL(SUM(Darsad),0)  As Darsad FROM (SELECT TOP 1 Darsad FROM  ListDarsad WHERE IdlinkKala =EndList.Id AND IdGroup =EndList.IdGroup AND Frosh <=EndList.DarsadFrosh ORDER By Frosh DESC) As DFrosh) FROM (SELECT GroupKala,Id,Idkala,Mon,Kala,IdVisitor,IdGroup,GroupNam,FroshK,KolCountK,DarsadFrosh=CASE WHEN @Cal=0 OR (@Cal=2 AND Mon>0) THEN CASE WHEN Mon<=0 THEN 0 ELSE ROUND(FroshK *100/Mon,2) END WHEN @Cal=1 OR (@Cal=2 AND Kala>0 AND Mon <=0) THEN CASE WHEN Kala<=0 THEN 0 ELSE ROUND(KolCountK *100/Kala ,2) END ELSE 0 END  FROM (SELECT GroupKala ,Id ,Idkala ,Mon ,Kala ,IdVisitor ,IdGroup ,GroupNam,FroshK=(SELECT ISNULL(ListAllFrosh.Mon,0) -ISNULL(ListAllBackFrosh.Mon,0)-ISNULL(ListAllKasri.Mon,0) As EndMon FROM (SELECT ISNULL(SUM(Mon),0) As Mon FROM (SELECT Mon-DarsadMon As Mon FROM KalaFactorSell INNER JOIN ListFactorSell ON ListFactorSell.IdFactor = KalaFactorSell.IdFactor WHERE (ListFactorSell.Stat =3 and ListFactorSell.Activ =1 AND ListFactorSell.IdVisitor IN(" & visitor & ") AND KalaFactorSell.IdKala IN (SELECT Id  FROM Define_Kala WHERE Id =ListGoal.Idkala) AND ListFactorSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListGoal.IdGroup  AND ChkIdGroup ='True') " & dat & ")) As ListFrosh ) As ListAllFrosh,(SELECT ISNULL(SUM(Mon),0) As Mon FROM (SELECT Mon-DarsadMon As Mon FROM KalaFactorBackSell INNER JOIN ListFactorBackSell ON ListFactorBackSell.IdFactor = KalaFactorBackSell.IdFactor WHERE (ListFactorBackSell.Activ =1 AND ListFactorBackSell.IdVisitor IN(" & visitor & ") AND KalaFactorBackSell.IdKala IN (SELECT Id  FROM Define_Kala WHERE Id =ListGoal.Idkala) AND ListFactorBackSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListGoal.IdGroup  AND ChkIdGroup ='True') " & dat & ")) As ListBackFrosh ) As ListAllBackFrosh ,(SELECT ISNULL(SUM(Mon),0) As Mon FROM (SELECT Mon-DarsadMon As Mon FROM KalaKasriFactor INNER JOIN ListKasriFactor ON KalaKasriFactor.IdFactor = ListKasriFactor.IdFactor INNER JOIN ListFactorSell ON ListKasriFactor.IdFactor = ListFactorSell.IdFactor  WHERE IdVisitor IN(" & visitor & ") AND KalaKasriFactor.IdR  IN (SELECT Id  FROM Define_Kala WHERE Id =ListGoal.Idkala) AND ListFactorSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListGoal.IdGroup  AND ChkIdGroup ='True') " & dat2 & ") As ListKasri ) As ListAllKasri),KolCountK=CASE WHEN @Cal=1 OR (@Cal=2 AND Kala>0 AND Mon <=0) THEN (SELECT ISNULL(ListAllFrosh.KolCount,0) -ISNULL(ListAllBackFrosh.KolCount,0)-ISNULL(ListAllKasri.KolCount,0) As KolCountK FROM (SELECT ISNULL(SUM(KolCount),0) As KolCount FROM (SELECT KolCount  FROM KalaFactorSell INNER JOIN ListFactorSell ON ListFactorSell.IdFactor = KalaFactorSell.IdFactor WHERE (ListFactorSell.Stat =3 and ListFactorSell.Activ =1 AND ListFactorSell.IdVisitor IN(" & visitor & ") AND KalaFactorSell.IdKala IN (SELECT Id  FROM Define_Kala WHERE Id =ListGoal.Idkala) AND ListFactorSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListGoal.IdGroup  AND ChkIdGroup ='True') " & dat & ")) As ListFrosh ) As ListAllFrosh,(SELECT ISNULL(SUM(KolCount),0) As KolCount FROM (SELECT KolCount  FROM KalaFactorBackSell INNER JOIN ListFactorBackSell ON ListFactorBackSell.IdFactor = KalaFactorBackSell.IdFactor WHERE (ListFactorBackSell.Activ =1 AND ListFactorBackSell.IdVisitor IN(" & visitor & ") AND KalaFactorBackSell.IdKala IN (SELECT Id  FROM Define_Kala WHERE Id=ListGoal.Idkala) AND ListFactorBackSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListGoal.IdGroup  AND ChkIdGroup ='True') " & dat & ")) As ListBackFrosh ) As ListAllBackFrosh ,(SELECT ISNULL(SUM(KolCount),0) As KolCount FROM (SELECT KolCount  FROM KalaKasriFactor INNER JOIN ListKasriFactor ON KalaKasriFactor.IdFactor = ListKasriFactor.IdFactor INNER JOIN ListFactorSell ON ListKasriFactor.IdFactor = ListFactorSell.IdFactor  WHERE IdVisitor IN(" & visitor & ") AND KalaKasriFactor.IdR  IN (SELECT Id  FROM Define_Kala WHERE Id =ListGoal.Idkala) AND ListFactorSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListGoal.IdGroup  AND ChkIdGroup ='True') " & dat2 & ") As ListKasri ) As ListAllKasri) WHEN @Cal=0 THEN 0 ELSE 0 END FROM (SELECT  DISTINCT Define_Kala.Nam As GroupKala,Listkala.Id ,Listkala.Idkala,Listkala.Mon,Listkala.Kala,Listkala.IdLinkVisitor As IdVisitor,ListDarsad.IdGroup,Define_Group_P.nam As GroupNam FROM  Listkala INNER JOIN Define_Kala ON Listkala.Idkala = Define_Kala.Id INNER JOIN ListDarsad ON Listkala.Id = ListDarsad.IdlinkKala INNER JOIN Define_Group_P ON ListDarsad.IdGroup = Define_Group_P.Id WHERE IdLinkVisitor =" & CmbBox.SelectedValue & ") As ListGoal) As ListFrosh) As EndList) As ListPorsant GROUP BY GroupKala"
                        FrmP.IdFactor = "DECLARE @Cal int SET @Cal=" & If(RdoMon.Checked = True, 0, If(RdoHajm.Checked = True, 1, 2)) & " SELECT SUM(FroshK) AS FroshK,SUM(KolCountK) AS KolCountK,Darsad=CASE WHEN SUM(FroshK)<=0 THEN 0 ELSE ROUND(SUM(ROUND(FroshK *Darsad /100,0))*100/SUM(FroshK),2) END,Porsant=SUM(ROUND(FroshK *Darsad /100,0)) FROM (SELECT Nam,Darsad,FroshK=(SELECT ISNULL(ListAllFrosh.Mon,0) -ISNULL(ListAllBackFrosh.Mon,0)-ISNULL(ListAllKasri.Mon,0) As EndMon FROM (SELECT ISNULL(SUM(Mon),0) As Mon FROM (SELECT Mon-DarsadMon AS Mon  FROM KalaFactorSell INNER JOIN ListFactorSell ON ListFactorSell.IdFactor = KalaFactorSell.IdFactor WHERE (ListFactorSell.Stat =3 and ListFactorSell.Activ =1 AND ListFactorSell.IdVisitor IN(" & visitor & ") AND KalaFactorSell.IdKala NOT IN (SELECT Id  FROM Define_Kala WHERE Id IN (SELECT  Idkala FROM Listkala WHERE IdLinkVisitor =ListOder.IdVisitor)) AND ListFactorSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListOder.IdGroup  AND ChkIdGroup ='True') " & dat & ")) As ListFrosh ) As ListAllFrosh,(SELECT ISNULL(SUM(Mon),0) As Mon FROM (SELECT Mon-DarsadMon AS Mon FROM KalaFactorBackSell INNER JOIN ListFactorBackSell ON ListFactorBackSell.IdFactor = KalaFactorBackSell.IdFactor WHERE (ListFactorBackSell.Activ =1 AND ListFactorBackSell.IdVisitor IN(" & visitor & ") AND KalaFactorBackSell.IdKala NOT IN (SELECT Id  FROM Define_Kala WHERE Id IN (SELECT  Idkala FROM Listkala WHERE IdLinkVisitor =ListOder.IdVisitor)) AND ListFactorBackSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListOder.IdGroup  AND ChkIdGroup ='True') " & dat & ")) As ListBackFrosh ) As ListAllBackFrosh ,(SELECT ISNULL(SUM(Mon),0) As Mon FROM (SELECT Mon-DarsadMon AS Mon FROM KalaKasriFactor INNER JOIN ListKasriFactor ON KalaKasriFactor.IdFactor = ListKasriFactor.IdFactor INNER JOIN ListFactorSell ON ListKasriFactor.IdFactor = ListFactorSell.IdFactor  WHERE IdVisitor IN(" & visitor & ") AND KalaKasriFactor.IdR NOT IN (SELECT Id  FROM Define_Kala WHERE Id IN (SELECT  Idkala FROM Listkala WHERE IdLinkVisitor =ListOder.IdVisitor)) AND ListFactorSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListOder.IdGroup  AND ChkIdGroup ='True') " & dat2 & ") As ListKasri ) As ListAllKasri),KolCountK=CASE WHEN @Cal=1 THEN (SELECT ISNULL(ListAllFrosh.KolCount,0) -ISNULL(ListAllBackFrosh.KolCount,0)-ISNULL(ListAllKasri.KolCount,0) As EndKolCount FROM (SELECT ISNULL(SUM(KolCount),0) As KolCount FROM (SELECT KolCount  FROM KalaFactorSell INNER JOIN ListFactorSell ON ListFactorSell.IdFactor = KalaFactorSell.IdFactor WHERE (ListFactorSell.Stat =3 and ListFactorSell.Activ =1 AND ListFactorSell.IdVisitor IN(" & visitor & ") AND KalaFactorSell.IdKala NOT IN (SELECT Id  FROM Define_Kala WHERE Id IN (SELECT  Idkala FROM Listkala  WHERE IdLinkVisitor =ListOder.IdVisitor)) AND ListFactorSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListOder.IdGroup  AND ChkIdGroup ='True') " & dat & ")) As ListFrosh ) As ListAllFrosh,(SELECT ISNULL(SUM(KolCount),0) As KolCount FROM (SELECT KolCount FROM KalaFactorBackSell INNER JOIN ListFactorBackSell ON ListFactorBackSell.IdFactor = KalaFactorBackSell.IdFactor WHERE (ListFactorBackSell.Activ =1 AND ListFactorBackSell.IdVisitor IN(" & visitor & ") AND KalaFactorBackSell.IdKala NOT IN (SELECT Id  FROM Define_Kala WHERE Id IN (SELECT  Idkala FROM Listkala WHERE IdLinkVisitor =ListOder.IdVisitor)) AND ListFactorBackSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListOder.IdGroup  AND ChkIdGroup ='True') " & dat & ")) As ListBackFrosh ) As ListAllBackFrosh ,(SELECT ISNULL(SUM(KolCount),0) As KolCount FROM (SELECT KolCount FROM KalaKasriFactor INNER JOIN ListKasriFactor ON KalaKasriFactor.IdFactor = ListKasriFactor.IdFactor INNER JOIN ListFactorSell ON ListKasriFactor.IdFactor = ListFactorSell.IdFactor  WHERE IdVisitor IN(" & visitor & ") AND KalaKasriFactor.IdR NOT IN (SELECT Id  FROM Define_Kala WHERE Id IN (SELECT  Idkala FROM Listkala WHERE IdLinkVisitor =ListOder.IdVisitor)) AND ListFactorSell.IdName IN (SELECT id FROM Define_People WHERE IdGroup =ListOder.IdGroup  AND ChkIdGroup ='True') " & dat2 & ") As ListKasri ) As ListAllKasri) ELSE 0 END FROM(SELECT ListOrderDarsad.Darsad,ListOrderDarsad.IdGroup,ListOrderDarsad.IdLinkVisitor AS IdVisitor,Define_Group_P.nam FROM   ListOrderDarsad INNER JOIN Define_Group_P  ON ListOrderDarsad.IdGroup  = Define_Group_P.Id WHERE  IdLinkVisitor =" & CmbBox.SelectedValue & ") As ListOder) As ListAllOder"
                        If RdoHybrid.Checked = True Then
                            FrmP.CHoose = "GOALKALA_G"
                        ElseIf RdoHajm.Checked = True Then
                            FrmP.CHoose = "GOALKALA_G_HAJM"
                        ElseIf RdoMon.Checked = True Then
                            FrmP.CHoose = "GOALKALA_G_MON"
                        End If
                    End If
                End If

                TraceUser(Id_User, GetDate(), CStr(Date.Now.ToLongTimeString), "فروش هدف", "تهیه گزارش", "فروش هدف ویزیتور:" & CmbBox.Text, "")

                FrmP.ShowDialog()
            End Using
            Me.Enabled = True

        Catch ex As Exception
            GetError(ex.Message & vbCrLf & vbCrLf & ex.StackTrace, "FrmGoalVisitor", "BtnOk_Click")
            Me.Enabled = True
        End Try
    End Sub

    Private Sub CmbBox_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles CmbBox.KeyDown
        If CmbBox.DroppedDown = False Then
            CmbBox.DroppedDown = True
        End If
        If e.KeyCode = Keys.Enter Then
            BtnOk.Focus()
        End If
    End Sub
    Private Sub GetKey(ByVal e As KeyEventArgs)
        If e.KeyCode = Keys.Escape Then
            Me.Close()
        ElseIf e.KeyCode = Keys.F1 Then
            Help.ShowHelp(Me, Application.StartupPath & "\Help.chm", HelpNavigator.Topic, "RepFroshHadaf.htm")
        ElseIf e.KeyCode = Keys.F2 Then
            If BtnOk.Enabled = True Then BtnOk_Click(Nothing, Nothing)
        End If
    End Sub

    Private Sub CheckBox1_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles CheckBox1.CheckedChanged
        If CheckBox1.Checked = True Then
            TxtGroup.Enabled = True
            Button1.Enabled = True
            TxtGroup.Focus()
        Else
            TxtGroup.Enabled = False
            Button1.Enabled = False
            TxtGroup.Text = ""
            TxtIdGroup.Text = ""
        End If
    End Sub

    Private Sub Button1_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Button1.Click
        Using FrmAdVance As New Visitor_List
            FrmAdVance.ChkAll.Visible = True
            FrmAdVance.DGV.Columns("Cln_select").Visible = True
            FrmAdVance.ShowDialog()
            Try
                If AllSelectKala.Length > 0 Then

                    TxtGroup.Clear()
                    TxtIdGroup.Clear()

                    For i As Integer = 0 To AllSelectKala.Length - 1
                        TxtGroup.Text &= AllSelectKala(i).Namekala & " - "
                        TxtIdGroup.Text &= AllSelectKala(i).IdKala & "-"
                    Next
                    TxtGroup.Text = TxtGroup.Text.Substring(0, TxtGroup.Text.Length - 3)
                    TxtIdGroup.Text = TxtIdGroup.Text.Substring(0, TxtIdGroup.Text.Length - 1)
                    Array.Resize(AllSelectKala, 0)
                End If
                TxtGroup.Focus()
            Catch ex As Exception
                Array.Resize(AllSelectKala, 0)
                TxtGroup.Clear()
                TxtIdGroup.Clear()
            End Try
        End Using
    End Sub

    Private Sub TxtGroup_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles TxtGroup.KeyDown
        If e.KeyCode = Keys.Enter Then BtnOk.Focus()
    End Sub

    Private Sub TxtGroup_KeyPress(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyPressEventArgs) Handles TxtGroup.KeyPress
        If e.KeyChar = ChrW(Keys.Enter) Then Exit Sub
        Dim frmlk As New Visitor_List
        frmlk.TxtSearch.Text = e.KeyChar()
        frmlk.BtnNewP.Enabled = True
        frmlk.ShowDialog()
        e.Handled = True
        TxtGroup.Focus()
        If Tmp_Namkala <> "" Then
            TxtGroup.Text = Tmp_Namkala
            TxtIdGroup.Text = IdKala
        Else
            TxtGroup.Text = ""
            TxtIdGroup.Text = ""
        End If
    End Sub

End Class